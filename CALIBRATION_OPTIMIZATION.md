# 🎯 校準優化報告

## 📅 更新日期
2025-12-02

## 📊 數據來源
- **數據文件**: `drumstick_calibration_1764661222663.json`
- **收集時間**: 2025-12-02T07:40:22.655Z
- **總樣本數**: 1,730 個數據點
- **位置分佈**:
  - Center (正前方): 593 樣本
  - Left (左方): 617 樣本
  - Right (右方): 520 樣本

## 🔬 數據分析結果

### 各位置姿態中位數

| 位置 | Roll | Pitch | Yaw |
|------|------|-------|-----|
| **Center** | 8.68° | -20.23° | 21.60° |
| **Left** | -21.76° | -12.36° | 34.53° |
| **Right** | 40.45° | -11.58° | 9.02° |

### 關鍵發現

1. **Yaw 是最穩定的方向指示器**
   - Center: 21.60° (標準差 1.66°)
   - Left: 34.53° (標準差 0.82°)
   - Right: 9.02° (標準差 1.57°)
   - ✅ **可以根據 Yaw 值自動判斷鼓棒位置**

2. **Roll 變化範圍大**
   - 範圍: -21.76° ~ 40.45°
   - 差異: 62.21°
   - 💡 表示握持方式或鼓棒旋轉影響顯著

3. **Pitch 在揮動時保持相對穩定**
   - 平均在 -12° ~ -20° 之間
   - 與靜止測量的 -84.8° 有顯著差異
   - 💡 表示揮動時鼓棒角度確實改變

## 🎛️ 計算出的最佳校準參數

### 方案 1: 單一校準 (推薦使用)

**目標姿態**: 
- Roll = 0° (無翻滾)
- Pitch = -90° (水平)
- Yaw = 0° (指向前方)

**校準參數**:
```javascript
rotationOffset = {
    roll: -8.68,
    pitch: -69.77,
    yaw: -21.60
};
```

**驗證結果**:
套用後,Center 位置會顯示為: Roll=0.00°, Pitch=-90.00°, Yaw=0.00°

### 方案 2: 多位置校準 (更精確)

根據 Yaw 值自動判斷位置並套用對應校準:

#### Yaw 範圍定義
- **Center**: 15° ~ 28° (中位數: 21.60°)
- **Left**: 28° ~ 38° (中位數: 34.53°)
- **Right**: 5° ~ 15° (中位數: 9.02°)

#### 各位置校準參數

**CENTER (正前方)**:
```javascript
{ roll: -8.68, pitch: -69.77, yaw: -21.60 }
```

**LEFT (左方)**:
```javascript
{ roll: 21.76, pitch: -77.64, yaw: -124.53 }
```

**RIGHT (右方)**:
```javascript
{ roll: -40.45, pitch: -78.42, yaw: 80.98 }
```

## 🚀 已更新的文件

### 1. `templates/calibration.html`
- ✅ 更新「預設：水平指向前」按鈕的校準值
- 新值: roll=-8.68, pitch=-69.77, yaw=-21.60
- 舊值: roll=3.9, pitch=84.8, yaw=-12.2

### 2. `templates/calibration_advanced.html`
- ✅ 更新 `CALIBRATION_PROFILES` 配置
- ✅ 更新頁面顯示的校準數值
- ✅ 支援自動位置偵測與校準切換

### 3. 新增文件
- ✅ `calculate_optimal_calibration.py` - 校準計算腳本
- ✅ `calibration_config.json` - 校準配置文件
- ✅ `CALIBRATION_OPTIMIZATION.md` - 本文件

## 📈 額外分析數據

### Z軸加速度統計 (擊鼓動作)
- **標準差**:
  - Center: 12.06 m/s²
  - Left: 12.90 m/s²
  - Right: 12.58 m/s²

- **建議擊鼓檢測閾值**: **34.83 m/s²**
  - 計算方式: 重力加速度 (9.8) + 2×最大標準差 (12.90)
  - 用於判斷是否為有效的擊鼓動作

## 🎮 使用方式

### 基本校準 (推薦)
1. 訪問 `http://<IP>:5000/calibration`
2. 點擊「📏 預設：水平指向前」按鈕
3. 系統會自動套用最佳校準值
4. 觀察畫面,鼓棒應該水平指向前方

### 進階校準 (自動位置偵測)
1. 訪問 `http://<IP>:5000/calibration-advanced`
2. 確保「自動校準」模式已啟用
3. 系統會根據 Yaw 值自動判斷位置
4. 自動套用對應的校準參數
5. 實時顯示偵測到的位置

### 手動微調
如果自動校準效果不理想,可以:
1. 在 `/calibration` 頁面使用滑桿微調
2. 調整 Roll、Pitch、Yaw 偏移值
3. 實時觀察效果
4. 保存設定 (localStorage)

## 🔍 校準原理說明

### 座標系統
- **X軸**: 沿著鼓棒長度方向 (尖端指向)
- **Y軸**: 垂直於鼓棒平面
- **Z軸**: 上下方向 (擊鼓動作方向)

### 旋轉順序
- **YXZ**: Yaw → Pitch → Roll
- 先旋轉偏航角,再俯仰角,最後翻滾角

### 校準策略
1. **使用中位數**: 比平均值更能抵抗異常值
2. **位置特定**: 不同方向使用不同校準參數
3. **自動偵測**: 根據 Yaw 值自動判斷位置

## 📝 校準驗證方法

### 驗證步驟
1. **Center 位置**:
   - 握持鼓棒水平,尖端指向前方 (Z軸正向)
   - 畫面應顯示: 鼓棒水平,尖端向前
   
2. **Left 位置**:
   - 握持鼓棒水平,尖端指向左方 (X軸負向)
   - 畫面應顯示: 鼓棒水平,尖端向左
   
3. **Right 位置**:
   - 握持鼓棒水平,尖端指向右方 (X軸正向)
   - 畫面應顯示: 鼓棒水平,尖端向右

### 預期效果
- ✅ 靜止時鼓棒保持穩定
- ✅ 揮動時運動流暢自然
- ✅ 擊鼓動作清晰可見
- ✅ 方向轉換即時反應

## 🛠️ 故障排除

### 問題 1: 鼓棒角度仍然不準確
**可能原因**: 
- 感測器安裝角度與數據收集時不同
- 握持方式改變

**解決方案**:
1. 重新收集校準數據
2. 使用手動微調功能
3. 檢查感測器固定方式

### 問題 2: 位置自動偵測不準確
**可能原因**:
- Yaw 值超出預定範圍
- 環境磁場干擾

**解決方案**:
1. 檢查 Yaw 範圍設定
2. 遠離強磁場環境
3. 重新校準磁力計

### 問題 3: 擊鼓動作不靈敏
**可能原因**:
- Z軸加速度閾值設定過高

**解決方案**:
1. 降低閾值 (建議: 25-35 m/s²)
2. 分析 Z軸加速度數據
3. 調整擊鼓力度

## 📚 相關文件

- `CALIBRATION_DATA.md` - 原始校準測量記錄
- `calibration_config.json` - 機器可讀的校準配置
- `analyze_calibration_data.py` - 數據分析腳本
- `calculate_optimal_calibration.py` - 校準計算腳本

## 🎉 改進效果

### 校準前
- Roll offset: 3.9° (基於單一測量)
- Pitch offset: 84.8° (基於單一測量)
- Yaw offset: -12.2° (基於單一測量)
- **問題**: 揮動時角度不準確

### 校準後
- Roll offset: -8.68° (基於 593 個樣本中位數)
- Pitch offset: -69.77° (基於 593 個樣本中位數)
- Yaw offset: -21.60° (基於 593 個樣本中位數)
- **改進**: 
  - ✅ 反映揮動時的實際姿態
  - ✅ 更穩定、更準確
  - ✅ 支援多位置自動校準

## 🔮 未來改進方向

1. **機器學習校準**
   - 使用神經網絡學習姿態映射
   - 自動補償握持方式變化

2. **動態校準**
   - 實時追蹤校準偏移
   - 自適應調整參數

3. **多感測器融合**
   - 結合視覺追蹤
   - 提高精度和可靠性

4. **用戶個性化**
   - 記錄個人使用習慣
   - 自動優化校準參數

---

**最後更新**: 2025-12-02
**版本**: 2.0
**狀態**: ✅ 已部署
