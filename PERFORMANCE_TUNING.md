# MPU6050 性能調校指南

## 🚀 當前配置（已優化）

### 感測器讀取頻率
```python
dt = 0.005  # 5 毫秒 = 200 Hz
```

**改進說明**：
- 原本：`dt = 0.01` (100 Hz)
- 現在：`dt = 0.005` (200 Hz) ⚡
- **提升 2 倍流暢度**

### 打擊冷卻時間
```python
cooldown = 0.05  # 50 毫秒
```

**改進說明**：
- 原本：`cooldown = 0.1` (100ms)
- 現在：`cooldown = 0.05` (50ms) ⚡
- **打擊響應速度提升 2 倍**

## 📊 性能等級對照表

| 等級 | dt (秒) | 頻率 (Hz) | 適用場景 |
|------|---------|----------|---------|
| 🐌 節能 | 0.02 | 50 | 省電模式，基本監控 |
| 📱 標準 | 0.01 | 100 | 原本設定，一般使用 |
| ⚡ 高速 | 0.005 | 200 | **目前設定**，推薦遊戲 |
| 🚀 極速 | 0.002 | 500 | 專業級，需要強大 CPU |
| 💥 瘋狂 | 0.001 | 1000 | 實驗用，可能不穩定 |

## 🎯 冷卻時間對照表

| 等級 | cooldown (秒) | 特性 |
|------|--------------|------|
| 🐢 寬鬆 | 0.2 | 避免誤觸發，適合初學者 |
| 📝 標準 | 0.1 | 原本設定，平衡 |
| ⚡ 快速 | 0.05 | **目前設定**，適合遊戲 |
| 🥁 專業 | 0.03 | 快速連打，需要精準 |
| 💨 極限 | 0.01 | 超快連打，可能誤觸發 |

## ⚙️ 如何調整

### 方法 1：直接修改代碼

編輯 `mpu6050_web_visual.py`：

```python
# 在第 37-38 行附近
dt = 0.005  # 修改這裡
cooldown = 0.05  # 修改這裡
```

### 方法 2：根據場景選擇

#### 場景 1：休閒遊戲（推薦）
```python
dt = 0.005       # 200 Hz
cooldown = 0.05  # 50 ms
threshold = 2.0  # 2.0g
```
- 流暢度：⭐⭐⭐⭐⭐
- CPU 使用：⭐⭐⭐
- 適合大部分遊戲

#### 場景 2：專業演奏
```python
dt = 0.002       # 500 Hz
cooldown = 0.03  # 30 ms
threshold = 1.5  # 1.5g (更靈敏)
```
- 流暢度：⭐⭐⭐⭐⭐
- CPU 使用：⭐⭐⭐⭐
- 需要樹莓派 4 或更高

#### 場景 3：展示/教學
```python
dt = 0.01        # 100 Hz
cooldown = 0.1   # 100 ms
threshold = 2.5  # 2.5g (較不靈敏)
```
- 流暢度：⭐⭐⭐
- CPU 使用：⭐⭐
- 穩定可靠

#### 場景 4：省電模式
```python
dt = 0.02        # 50 Hz
cooldown = 0.15  # 150 ms
threshold = 3.0  # 3.0g
```
- 流暢度：⭐⭐
- CPU 使用：⭐
- 電池續航最長

## 🔧 進階優化

### 1. Alpha 值調整（互補濾波器）

```python
alpha = 0.98  # 預設值
```

| Alpha | 陀螺儀權重 | 加速度計權重 | 特性 |
|-------|-----------|-------------|------|
| 0.90 | 90% | 10% | 快速響應，但可能抖動 |
| 0.95 | 95% | 5% | 平衡 |
| **0.98** | 98% | 2% | **目前設定**，平滑穩定 |
| 0.99 | 99% | 1% | 非常平滑，但反應慢 |

### 2. 打擊閾值調整

```python
threshold = 2.0  # 當前設定 (g)
```

| 閾值 | 靈敏度 | 適用場景 |
|------|--------|---------|
| 1.0g | 極高 | 輕敲也能觸發 |
| 1.5g | 高 | 正常敲擊 |
| **2.0g** | **中** | **目前設定**，平衡 |
| 2.5g | 低 | 需要用力敲 |
| 3.0g | 極低 | 重擊才觸發 |

## 📈 性能監控

### 查看當前性能

在伺服器啟動時會顯示：

```
🌐 伺服器啟動中...
========================================================
請在瀏覽器開啟: http://<樹莓派IP>:5000

功能:
  ✓ 3D 鼓棒視覺化
  ✓ 爵士鼓場景
  ✓ 打擊偵測（閾值: 2.0g）
  ✓ 網頁端音效播放
  ✓ 更新頻率: 200 Hz  ← 新增顯示
```

### 效能指標

| 指標 | 計算方式 | 理想值 |
|------|---------|--------|
| 更新頻率 | 1 / dt | ≥ 100 Hz |
| 打擊延遲 | cooldown | ≤ 100 ms |
| CPU 使用率 | - | < 50% |

## ⚠️ 注意事項

### 1. CPU 限制

**樹莓派 3B / 3B+**:
- 推薦：100-200 Hz
- 最大：200-300 Hz
- 超過可能卡頓

**樹莓派 4 / 5**:
- 推薦：200-500 Hz
- 最大：500-1000 Hz
- 更高性能餘裕

### 2. USB 供電問題

高頻率讀取會增加功耗：
- 使用至少 2.5A 電源供應器
- 避免從電腦 USB 供電
- 考慮使用 3A 或更高規格

### 3. I²C 速度限制

MPU6050 使用 I²C 通訊：
- 標準模式：100 kHz
- 快速模式：400 kHz（預設）
- 最大理論：約 1000 Hz

### 4. WebSocket 延遲

網路延遲約 10-50ms：
- 區域網路：10-20ms
- WiFi：20-50ms
- 可能成為瓶頸

## 🧪 測試建議

### 測試步驟

1. **基準測試**（當前設定）
   ```bash
   python mpu6050_web_visual.py
   ```
   - 觀察流暢度
   - 記錄 CPU 使用率

2. **壓力測試**（極限設定）
   ```python
   dt = 0.002  # 500 Hz
   cooldown = 0.02
   ```
   - 檢查是否卡頓
   - 確認打擊偵測準確度

3. **降級測試**（如果太卡）
   ```python
   dt = 0.01  # 100 Hz
   cooldown = 0.08
   ```

### 判斷標準

✅ **良好**：
- 畫面流暢不卡頓
- 打擊響應快速
- CPU < 60%

⚠️ **可接受**：
- 偶爾小卡頓
- 打擊稍有延遲
- CPU 60-80%

❌ **需降級**：
- 畫面明顯卡頓
- 打擊延遲明顯
- CPU > 80%

## 💡 最佳實踐建議

### 推薦配置（已套用）

```python
# 高性能配置 - 適合遊戲
dt = 0.005          # 200 Hz - 流暢
cooldown = 0.05     # 50ms - 快速響應
threshold = 2.0     # 2.0g - 中等靈敏度
alpha = 0.98        # 98% - 穩定平滑
```

### 如果還是覺得卡

嘗試以下調整：

1. **稍微降低頻率**
   ```python
   dt = 0.0067  # 150 Hz (介於中間)
   ```

2. **優化網路**
   - 使用有線網路代替 WiFi
   - 確保路由器在附近
   - 關閉其他網路應用

3. **減少背景程序**
   ```bash
   # 檢查 CPU 使用
   top
   
   # 關閉不需要的服務
   sudo systemctl stop xxx
   ```

4. **超頻樹莓派**（進階）
   ```bash
   sudo nano /boot/config.txt
   # 添加（樹莓派 4）:
   over_voltage=2
   arm_freq=1750
   ```

## 📊 效能對比

### 當前優化效果

| 項目 | 優化前 | 優化後 | 提升 |
|------|--------|--------|------|
| 更新頻率 | 100 Hz | 200 Hz | +100% |
| 打擊延遲 | 100 ms | 50 ms | -50% |
| 流暢度 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | +67% |

### 預期體驗

- ✅ 鼓棒移動更順暢
- ✅ 打擊響應更靈敏
- ✅ 遊戲體驗更好
- ⚠️ CPU 使用率稍微提高（可接受範圍）

---

**版本**: 1.0  
**更新日期**: 2025-12-02  
**優化**: 200 Hz / 50ms  
**作者**: Eleanor
