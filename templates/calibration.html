<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¼“æ£’åƒæ•¸å¾®èª¿ - MPU6050</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
            height: 100vh;
        }

        #container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-family: 'Courier New', monospace;
            max-width: 350px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .overlay h2 {
            margin-bottom: 15px;
            font-size: 20px;
            color: #4fc3f7;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 8px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 15px;
            margin-bottom: 20px;
        }

        .data-label {
            color: #aaa;
            font-weight: bold;
        }

        .data-value {
            color: #4fc3f7;
            font-weight: bold;
            text-align: right;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .status-disconnected {
            background: #f44336;
            box-shadow: 0 0 10px #f44336;
        }

        /* å³å´æ§åˆ¶é¢æ¿ */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            padding: 25px;
            color: white;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .control-panel h2 {
            margin-bottom: 20px;
            font-size: 20px;
            color: #ff9800;
            border-bottom: 2px solid #ff9800;
            padding-bottom: 8px;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-section h3 {
            color: #ffc107;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .slider-name {
            color: #aaa;
            font-weight: bold;
        }

        .slider-value {
            color: #4fc3f7;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4fc3f7;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4fc3f7;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 14px;
            margin-top: 5px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 87, 108, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 242, 254, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(254, 225, 64, 0.4);
        }

        .info-text {
            font-size: 12px;
            color: #aaa;
            margin-top: 10px;
            line-height: 1.5;
        }

        /* åº§æ¨™è»¸èªªæ˜ */
        .axis-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 15px;
            color: white;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .axis-info h3 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #4fc3f7;
        }

        .axis-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .axis-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .axis-color {
            width: 30px;
            height: 4px;
            border-radius: 2px;
        }

        .x-axis { background: #ff0000; }
        .y-axis { background: #00ff00; }
        .z-axis { background: #0000ff; }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .control-panel::-webkit-scrollbar {
            width: 8px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: rgba(79, 195, 247, 0.5);
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 195, 247, 0.8);
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <!-- å·¦å´æ•¸æ“šé¡¯ç¤º -->
    <div class="overlay">
        <h2>ğŸ“Š å³æ™‚æ„Ÿæ¸¬å™¨æ•¸æ“š</h2>
        <div class="data-grid">
            <span class="data-label">é€£ç·šç‹€æ…‹:</span>
            <span>
                <span class="status-indicator status-disconnected" id="status-indicator"></span>
                <span class="data-value" id="status">æœªé€£æ¥</span>
            </span>
            
            <span class="data-label">Roll (æ©«æ»¾):</span>
            <span class="data-value" id="roll">0.0Â°</span>
            
            <span class="data-label">Pitch (ä¿¯ä»°):</span>
            <span class="data-value" id="pitch">0.0Â°</span>
            
            <span class="data-label">Yaw (åèˆª):</span>
            <span class="data-value" id="yaw">0.0Â°</span>
            
            <span class="data-label">åŠ é€Ÿåº¦ X:</span>
            <span class="data-value" id="accel-x">0.00 m/sÂ²</span>
            
            <span class="data-label">åŠ é€Ÿåº¦ Y:</span>
            <span class="data-value" id="accel-y">0.00 m/sÂ²</span>
            
            <span class="data-label">åŠ é€Ÿåº¦ Z:</span>
            <span class="data-value" id="accel-z">0.00 m/sÂ²</span>
            
            <span class="data-label">ç¸½åŠ é€Ÿåº¦:</span>
            <span class="data-value" id="accel-total">0.00 m/sÂ²</span>
            
            <span class="data-label">æº«åº¦:</span>
            <span class="data-value" id="temp">0.0Â°C</span>
        </div>
    </div>

    <!-- å³å´æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <h2>âš™ï¸ åƒæ•¸å¾®èª¿</h2>

        <!-- ä½ç½®åç§» -->
        <div class="control-section">
            <h3>ğŸ“ ä½ç½®åç§» (Position Offset)</h3>
            
            <div class="slider-group">
                <div class="slider-label">
                    <span class="slider-name">X è»¸åç§»:</span>
                    <span class="slider-value"><span id="offset-x-value">0</span> å–®ä½</span>
                </div>
                <input type="range" id="offset-x" min="-10" max="10" step="0.1" value="0">
                <input type="number" id="offset-x-input" min="-10" max="10" step="0.1" value="0" placeholder="ç²¾ç¢ºè¼¸å…¥">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span class="slider-name">Y è»¸åç§»:</span>
                    <span class="slider-value"><span id="offset-y-value">0</span> å–®ä½</span>
                </div>
                <input type="range" id="offset-y" min="-10" max="10" step="0.1" value="0">
                <input type="number" id="offset-y-input" min="-10" max="10" step="0.1" value="0" placeholder="ç²¾ç¢ºè¼¸å…¥">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span class="slider-name">Z è»¸åç§»:</span>
                    <span class="slider-value"><span id="offset-z-value">0</span> å–®ä½</span>
                </div>
                <input type="range" id="offset-z" min="-10" max="10" step="0.1" value="0">
                <input type="number" id="offset-z-input" min="-10" max="10" step="0.1" value="0" placeholder="ç²¾ç¢ºè¼¸å…¥">
            </div>

            <div class="btn-group">
                <button class="btn-success" id="apply-position-btn">âœ“ å¥—ç”¨ä½ç½®</button>
                <button class="btn-warning" id="reset-position-btn">â†º é‡ç½®ä½ç½®</button>
            </div>
        </div>

        <!-- æ—‹è½‰åç§» -->
        <div class="control-section">
            <h3>ğŸ”„ æ—‹è½‰åç§» (Rotation Offset)</h3>
            
            <div class="slider-group">
                <div class="slider-label">
                    <span class="slider-name">Roll åç§»:</span>
                    <span class="slider-value"><span id="rotation-roll-value">0</span>Â°</span>
                </div>
                <input type="range" id="rotation-roll" min="-180" max="180" step="1" value="0">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span class="slider-name">Pitch åç§»:</span>
                    <span class="slider-value"><span id="rotation-pitch-value">0</span>Â°</span>
                </div>
                <input type="range" id="rotation-pitch" min="-180" max="180" step="1" value="0">
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span class="slider-name">Yaw åç§»:</span>
                    <span class="slider-value"><span id="rotation-yaw-value">0</span>Â°</span>
                </div>
                <input type="range" id="rotation-yaw" min="-180" max="180" step="1" value="0">
            </div>

            <div class="btn-group">
                <button class="btn-success" id="apply-rotation-btn">âœ“ å¥—ç”¨æ—‹è½‰</button>
                <button class="btn-warning" id="reset-rotation-btn">â†º é‡ç½®æ—‹è½‰</button>
            </div>
        </div>

        <!-- è»¸æ–¹å‘åè½‰ -->
        <div class="control-section">
            <h3>ğŸ”€ è»¸æ–¹å‘åè½‰ (Axis Inversion)</h3>
            
            <div class="slider-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="invert-roll" style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="color: #ddd;">åè½‰ Roll è»¸ (æ©«æ»¾)</span>
                </label>
            </div>

            <div class="slider-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="invert-pitch" style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="color: #ddd;">åè½‰ Pitch è»¸ (ä¿¯ä»°)</span>
                </label>
            </div>

            <div class="slider-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="invert-yaw" style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="color: #ddd;">åè½‰ Yaw è»¸ (åèˆª)</span>
                </label>
            </div>

            <p class="info-text">
                ğŸ’¡ å‹¾é¸å¾Œï¼Œè©²è»¸çš„ç§»å‹•æ–¹å‘æœƒåè½‰ã€‚ä¾‹å¦‚ï¼šåŸæœ¬å‘å·¦è®Šæˆå‘å³ã€‚
            </p>
        </div>

        <!-- å¿«é€Ÿå‹•ä½œ -->
        <div class="control-section">
            <h3>âš¡ å¿«é€Ÿå‹•ä½œ</h3>
            
            <div class="btn-group">
                <button class="btn-primary" id="calibrate-btn">ğŸ¯ è‡ªå‹•æ ¡æº–</button>
                <button class="btn-secondary" id="reset-all-btn">ğŸ”„ å…¨éƒ¨é‡ç½®</button>
            </div>

            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn-success" id="save-settings-btn">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button class="btn-warning" id="load-settings-btn">ğŸ“‚ è¼‰å…¥è¨­å®š</button>
            </div>

            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn-primary" id="preset-horizontal-btn" style="font-size: 12px;">ğŸ“ é è¨­ï¼šæ°´å¹³æŒ‡å‘å‰</button>
            </div>

            <p class="info-text">
                ğŸ’¡ æç¤ºï¼šã€Œè‡ªå‹•æ ¡æº–ã€å°‡ç•¶å‰å§¿æ…‹è¨­ç‚ºé›¶é»ã€‚<br>
                ã€Œæ°´å¹³æŒ‡å‘å‰ã€å¥—ç”¨æ¸¬é‡çš„æ¨™æº–å§¿æ…‹åç§»ã€‚
            </p>
        </div>
    </div>

    <!-- åº§æ¨™è»¸èªªæ˜ -->
    <div class="axis-info">
        <h3>ğŸ“ åº§æ¨™è»¸èªªæ˜</h3>
        <div class="axis-legend">
            <div class="axis-item">
                <div class="axis-color x-axis"></div>
                <span>X è»¸ (ç´…è‰²) - å·¦å³æ–¹å‘</span>
            </div>
            <div class="axis-item">
                <div class="axis-color y-axis"></div>
                <span>Y è»¸ (ç¶ è‰²) - ä¸Šä¸‹æ–¹å‘</span>
            </div>
            <div class="axis-item">
                <div class="axis-color z-axis"></div>
                <span>Z è»¸ (è—è‰²) - å‰å¾Œæ–¹å‘</span>
            </div>
        </div>
    </div>

    <script>
        // Three.js è®Šæ•¸
        let scene, camera, renderer;
        let drumStick;
        let grid;

        // Socket.IO é€£æ¥
        const socket = io();

        // åç§»é‡
        let positionOffset = { x: 0, y: 0, z: 0 };
        let rotationOffset = { roll: 0, pitch: 0, yaw: 0 };

        // è»¸åè½‰è¨­å®š
        let axisInversion = { roll: false, pitch: false, yaw: false };

        // ç•¶å‰æ„Ÿæ¸¬å™¨æ•¸æ“š
        let currentSensorData = { roll: 0, pitch: 0, yaw: 0 };

        // åˆå§‹åŒ– Three.js å ´æ™¯
        function init() {
            console.log('ğŸ¬ åˆå§‹åŒ– Three.js å ´æ™¯...');
            
            // å‰µå»ºå ´æ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.Fog(0x0a0a0a, 10, 50);

            // å‰µå»ºç›¸æ©Ÿ
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);

            // å‰µå»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);

            // æ·»åŠ ç’°å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // æ·»åŠ èšå…‰ç‡ˆ
            const spotLight = new THREE.SpotLight(0xffffff, 0.8);
            spotLight.position.set(10, 20, 10);
            spotLight.castShadow = true;
            spotLight.shadow.mapSize.width = 2048;
            spotLight.shadow.mapSize.height = 2048;
            scene.add(spotLight);

            // æ·»åŠ æ–¹å‘å…‰
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(-5, 10, -5);
            scene.add(dirLight);

            // å‰µå»ºåœ°é¢ç¶²æ ¼
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            scene.add(gridHelper);

            // å‰µå»ºåº§æ¨™è»¸ï¼ˆæ›´å¤§æ›´æ˜é¡¯ï¼‰
            const axesHelper = new THREE.AxesHelper(8);
            scene.add(axesHelper);

            // æ·»åŠ åº§æ¨™è»¸æ¨™ç±¤
            createAxisLabels();

            // å‰µå»ºåŸé»æ¨™è¨˜
            const originGeometry = new THREE.SphereGeometry(0.1, 16, 16);
            const originMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffffff,
                transparent: true,
                opacity: 0.8
            });
            const originMarker = new THREE.Mesh(originGeometry, originMaterial);
            scene.add(originMarker);

            // å‰µå»ºé¼“æ£’
            createDrumStick();

            // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
            window.addEventListener('resize', onWindowResize);

            // é–‹å§‹å‹•ç•«å¾ªç’°
            animate();

            console.log('âœ“ Three.js å ´æ™¯åˆå§‹åŒ–å®Œæˆ');
        }

        // å‰µå»ºåº§æ¨™è»¸æ¨™ç±¤
        function createAxisLabels() {
            // ä½¿ç”¨å°çƒé«”ä½œç‚ºè»¸ç«¯æ¨™è¨˜
            const markerGeometry = new THREE.SphereGeometry(0.15, 16, 16);
            
            // Xè»¸æ¨™è¨˜ (ç´…è‰²)
            const xMarker = new THREE.Mesh(
                markerGeometry,
                new THREE.MeshBasicMaterial({ color: 0xff0000 })
            );
            xMarker.position.set(8, 0, 0);
            scene.add(xMarker);

            // Yè»¸æ¨™è¨˜ (ç¶ è‰²)
            const yMarker = new THREE.Mesh(
                markerGeometry,
                new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            yMarker.position.set(0, 8, 0);
            scene.add(yMarker);

            // Zè»¸æ¨™è¨˜ (è—è‰²)
            const zMarker = new THREE.Mesh(
                markerGeometry,
                new THREE.MeshBasicMaterial({ color: 0x0000ff })
            );
            zMarker.position.set(0, 0, 8);
            scene.add(zMarker);
        }

        // å‰µå»ºé¼“æ£’
        function createDrumStick() {
            console.log('ğŸ¥¢ å‰µå»ºé¼“æ£’...');
            
            drumStick = new THREE.Group();

            // é¼“æ£’ä¸»é«”
            const stickLength = 3;
            const stickRadius = 0.08;
            const stickGeometry = new THREE.CylinderGeometry(
                stickRadius,
                stickRadius * 0.7,
                stickLength,
                16
            );
            const stickMaterial = new THREE.MeshStandardMaterial({
                color: 0x8B4513,
                roughness: 0.8,
                metalness: 0.1
            });
            const stick = new THREE.Mesh(stickGeometry, stickMaterial);
            stick.castShadow = true;
            drumStick.add(stick);

            // é¼“æ£’é ­
            const tipGeometry = new THREE.SphereGeometry(stickRadius * 1.5, 16, 16);
            const tipMaterial = new THREE.MeshStandardMaterial({
                color: 0xFFE4B5,
                roughness: 0.6,
                metalness: 0.2
            });
            const tip = new THREE.Mesh(tipGeometry, tipMaterial);
            tip.position.y = -stickLength / 2 - stickRadius * 0.5;
            tip.castShadow = true;
            drumStick.add(tip);

            // é¼“æ£’æ¡æŠŠ
            const gripGeometry = new THREE.CylinderGeometry(
                stickRadius * 1.2,
                stickRadius * 1.2,
                0.5,
                16
            );
            const gripMaterial = new THREE.MeshStandardMaterial({
                color: 0x333333,
                roughness: 0.9
            });
            const grip = new THREE.Mesh(gripGeometry, gripMaterial);
            grip.position.y = stickLength / 2;
            grip.castShadow = true;
            drumStick.add(grip);

            // æ·»åŠ æ–¹å‘æŒ‡ç¤ºå™¨ï¼ˆå°ç®­é ­ï¼‰
            const arrowGeometry = new THREE.ConeGeometry(0.1, 0.3, 8);
            const arrowMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
            arrow.position.y = -stickLength / 2 - stickRadius * 1.5 - 0.3;
            arrow.rotation.x = Math.PI;
            drumStick.add(arrow);

            // è¨­ç½®åˆå§‹ä½ç½®ï¼ˆç¨å¾®åç§»ä»¥ä¾¿è§€å¯Ÿï¼‰
            drumStick.position.set(0, 2, 0);

            scene.add(drumStick);
            console.log('âœ“ é¼“æ£’å‰µå»ºå®Œæˆ');
        }

        // æ›´æ–°é¼“æ£’å§¿æ…‹
        function updateDrumStick() {
            if (!drumStick) return;

            // å¥—ç”¨ä½ç½®åç§»
            drumStick.position.set(
                positionOffset.x,
                2 + positionOffset.y,
                positionOffset.z
            );

            // å¥—ç”¨æ—‹è½‰ï¼ˆæ„Ÿæ¸¬å™¨æ•¸æ“š + åç§»ï¼‰
            // æ‡‰ç”¨è»¸åè½‰
            let roll = currentSensorData.roll;
            let pitch = currentSensorData.pitch;
            let yaw = currentSensorData.yaw;

            // å¦‚æœå‹¾é¸åè½‰ï¼Œå‰‡å–è² å€¼
            if (axisInversion.roll) roll = -roll;
            if (axisInversion.pitch) pitch = -pitch;
            if (axisInversion.yaw) yaw = -yaw;

            // åŠ ä¸Šåç§»é‡ä¸¦è½‰æ›ç‚ºå¼§åº¦
            roll = (roll + rotationOffset.roll) * Math.PI / 180;
            pitch = (pitch + rotationOffset.pitch) * Math.PI / 180;
            yaw = (yaw + rotationOffset.yaw) * Math.PI / 180;

            // Three.js æ—‹è½‰é‚è¼¯
            // ç•¶ pitch=-84.8Â° ä¸”åŠ ä¸Š offset=84.8Â° å¾Œï¼Œpitch=0ï¼ˆæ°´å¹³ï¼‰
            // é¼“æ£’æ¨¡å‹é è¨­æ˜¯å‚ç›´çš„ï¼ˆæ²¿ Y è»¸ï¼‰ï¼Œéœ€è¦æ—‹è½‰åˆ°æ°´å¹³
            
            // è¨­å®šæ—‹è½‰é †åºç‚º YXZ (Yaw -> Pitch -> Roll)
            drumStick.rotation.order = 'YXZ';
            
            drumStick.rotation.set(
                pitch,      // X è»¸æ—‹è½‰ï¼ˆä¿¯ä»°ï¼‰- æ§åˆ¶ä¸Šä¸‹
                yaw,        // Y è»¸æ—‹è½‰ï¼ˆåèˆªï¼‰- æ§åˆ¶å·¦å³è½‰å‘
                roll        // Z è»¸æ—‹è½‰ï¼ˆæ©«æ»¾ï¼‰- æ§åˆ¶ç¿»æ»¾
            );
        }

        // å‹•ç•«å¾ªç’°
        function animate() {
            requestAnimationFrame(animate);

            // å›ºå®šç›¸æ©Ÿä½ç½®ï¼Œä¸æ—‹è½‰
            // å¾ Z è»¸æ­£æ–¹å‘çœ‹å‘åŸé»ï¼ˆæ­£å‰æ–¹è¦–è§’ï¼‰
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 2, 0);

            renderer.render(scene, camera);
        }

        // è¦–çª—å¤§å°èª¿æ•´
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Socket.IO äº‹ä»¶è™•ç†
        socket.on('connect', () => {
            console.log('âœ“ WebSocket å·²é€£æ¥');
            document.getElementById('status').textContent = 'å·²é€£æ¥';
            document.getElementById('status-indicator').className = 'status-indicator status-connected';
        });

        socket.on('disconnect', () => {
            console.log('âœ— WebSocket å·²æ–·ç·š');
            document.getElementById('status').textContent = 'æœªé€£æ¥';
            document.getElementById('status-indicator').className = 'status-indicator status-disconnected';
        });

        socket.on('sensor_data', (data) => {
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('roll').textContent = data.roll.toFixed(1) + 'Â°';
            document.getElementById('pitch').textContent = data.pitch.toFixed(1) + 'Â°';
            document.getElementById('yaw').textContent = data.yaw.toFixed(1) + 'Â°';
            document.getElementById('accel-x').textContent = data.accel.x.toFixed(2) + ' m/sÂ²';
            document.getElementById('accel-y').textContent = data.accel.y.toFixed(2) + ' m/sÂ²';
            document.getElementById('accel-z').textContent = data.accel.z.toFixed(2) + ' m/sÂ²';
            
            const totalAccel = Math.sqrt(
                data.accel.x ** 2 + 
                data.accel.y ** 2 + 
                data.accel.z ** 2
            );
            document.getElementById('accel-total').textContent = totalAccel.toFixed(2) + ' m/sÂ²';
            document.getElementById('temp').textContent = data.temperature.toFixed(1) + 'Â°C';

            // æ›´æ–°ç•¶å‰æ•¸æ“š
            currentSensorData = {
                roll: data.roll,
                pitch: data.pitch,
                yaw: data.yaw
            };

            // æ›´æ–°é¼“æ£’å§¿æ…‹
            updateDrumStick();
        });

        // UI æ§åˆ¶äº‹ä»¶

        // ä½ç½®åç§»æ»‘æ¡¿
        ['x', 'y', 'z'].forEach(axis => {
            const slider = document.getElementById(`offset-${axis}`);
            const input = document.getElementById(`offset-${axis}-input`);
            const value = document.getElementById(`offset-${axis}-value`);

            slider.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                value.textContent = val.toFixed(1);
                input.value = val;
                positionOffset[axis] = val;
                updateDrumStick();
            });

            input.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value) || 0;
                slider.value = val;
                value.textContent = val.toFixed(1);
                positionOffset[axis] = val;
                updateDrumStick();
            });
        });

        // æ—‹è½‰åç§»æ»‘æ¡¿
        ['roll', 'pitch', 'yaw'].forEach(axis => {
            const slider = document.getElementById(`rotation-${axis}`);
            const value = document.getElementById(`rotation-${axis}-value`);

            slider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                value.textContent = val;
                rotationOffset[axis] = val;
                updateDrumStick();
            });
        });

        // è»¸åè½‰è¤‡é¸æ¡†
        ['roll', 'pitch', 'yaw'].forEach(axis => {
            const checkbox = document.getElementById(`invert-${axis}`);
            checkbox.addEventListener('change', (e) => {
                axisInversion[axis] = e.target.checked;
                updateDrumStick();
                console.log(`${axis} è»¸åè½‰: ${e.target.checked ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'}`);
            });
        });

        // å¥—ç”¨ä½ç½®æŒ‰éˆ•
        document.getElementById('apply-position-btn').addEventListener('click', () => {
            console.log('âœ“ ä½ç½®åç§»å·²å¥—ç”¨:', positionOffset);
            showFeedback('apply-position-btn', 'âœ“ å·²å¥—ç”¨');
        });

        // é‡ç½®ä½ç½®æŒ‰éˆ•
        document.getElementById('reset-position-btn').addEventListener('click', () => {
            positionOffset = { x: 0, y: 0, z: 0 };
            ['x', 'y', 'z'].forEach(axis => {
                document.getElementById(`offset-${axis}`).value = 0;
                document.getElementById(`offset-${axis}-input`).value = 0;
                document.getElementById(`offset-${axis}-value`).textContent = '0';
            });
            updateDrumStick();
            console.log('âœ“ ä½ç½®å·²é‡ç½®');
            showFeedback('reset-position-btn', 'âœ“ å·²é‡ç½®');
        });

        // å¥—ç”¨æ—‹è½‰æŒ‰éˆ•
        document.getElementById('apply-rotation-btn').addEventListener('click', () => {
            console.log('âœ“ æ—‹è½‰åç§»å·²å¥—ç”¨:', rotationOffset);
            showFeedback('apply-rotation-btn', 'âœ“ å·²å¥—ç”¨');
        });

        // é‡ç½®æ—‹è½‰æŒ‰éˆ•
        document.getElementById('reset-rotation-btn').addEventListener('click', () => {
            rotationOffset = { roll: 0, pitch: 0, yaw: 0 };
            ['roll', 'pitch', 'yaw'].forEach(axis => {
                document.getElementById(`rotation-${axis}`).value = 0;
                document.getElementById(`rotation-${axis}-value`).textContent = '0';
            });
            updateDrumStick();
            console.log('âœ“ æ—‹è½‰å·²é‡ç½®');
            showFeedback('reset-rotation-btn', 'âœ“ å·²é‡ç½®');
        });

        // è‡ªå‹•æ ¡æº–æŒ‰éˆ•
        document.getElementById('calibrate-btn').addEventListener('click', () => {
            // å°‡ç•¶å‰å§¿æ…‹è¨­ç‚ºé›¶é»
            rotationOffset.roll = -currentSensorData.roll;
            rotationOffset.pitch = -currentSensorData.pitch;
            rotationOffset.yaw = -currentSensorData.yaw;

            // æ›´æ–°æ»‘æ¡¿
            document.getElementById('rotation-roll').value = rotationOffset.roll;
            document.getElementById('rotation-roll-value').textContent = rotationOffset.roll.toFixed(0);
            document.getElementById('rotation-pitch').value = rotationOffset.pitch;
            document.getElementById('rotation-pitch-value').textContent = rotationOffset.pitch.toFixed(0);
            document.getElementById('rotation-yaw').value = rotationOffset.yaw;
            document.getElementById('rotation-yaw-value').textContent = rotationOffset.yaw.toFixed(0);

            updateDrumStick();
            console.log('âœ“ è‡ªå‹•æ ¡æº–å®Œæˆ:', rotationOffset);
            showFeedback('calibrate-btn', 'âœ“ æ ¡æº–å®Œæˆ');
        });

        // å…¨éƒ¨é‡ç½®æŒ‰éˆ•
        document.getElementById('reset-all-btn').addEventListener('click', () => {
            // é‡ç½®æ‰€æœ‰åç§»
            positionOffset = { x: 0, y: 0, z: 0 };
            rotationOffset = { roll: 0, pitch: 0, yaw: 0 };
            axisInversion = { roll: false, pitch: false, yaw: false };

            // é‡ç½®æ‰€æœ‰æ»‘æ¡¿
            ['x', 'y', 'z'].forEach(axis => {
                document.getElementById(`offset-${axis}`).value = 0;
                document.getElementById(`offset-${axis}-input`).value = 0;
                document.getElementById(`offset-${axis}-value`).textContent = '0';
            });

            ['roll', 'pitch', 'yaw'].forEach(axis => {
                document.getElementById(`rotation-${axis}`).value = 0;
                document.getElementById(`rotation-${axis}-value`).textContent = '0';
                document.getElementById(`invert-${axis}`).checked = false;
            });

            updateDrumStick();
            console.log('âœ“ å…¨éƒ¨é‡ç½®å®Œæˆ');
            showFeedback('reset-all-btn', 'âœ“ å·²é‡ç½®');
        });

        // é è¨­ï¼šæ°´å¹³æŒ‡å‘å‰æŒ‰éˆ•
        document.getElementById('preset-horizontal-btn').addEventListener('click', () => {
            // æ ¹æ“šæœ€æ–°æ¸¬é‡æ•¸æ“šè¨­å®šåç§»ï¼ˆæ°´å¹³æŒ‡å‘å‰ä½œç‚ºé›¶é»ï¼‰
            // æ¸¬é‡å€¼: roll=-3.9, pitch=-84.8, yaw=12.2
            rotationOffset.roll = 3.9;    // åå‘åç§»
            rotationOffset.pitch = 84.8;  // åå‘åç§»
            rotationOffset.yaw = -12.2;   // åå‘åç§»

            // æ›´æ–°æ»‘æ¡¿
            document.getElementById('rotation-roll').value = rotationOffset.roll;
            document.getElementById('rotation-roll-value').textContent = rotationOffset.roll.toFixed(1);
            document.getElementById('rotation-pitch').value = rotationOffset.pitch;
            document.getElementById('rotation-pitch-value').textContent = rotationOffset.pitch.toFixed(1);
            document.getElementById('rotation-yaw').value = rotationOffset.yaw;
            document.getElementById('rotation-yaw-value').textContent = rotationOffset.yaw.toFixed(1);

            updateDrumStick();
            console.log('âœ“ é è¨­æ ¡æº–å®Œæˆï¼ˆæ°´å¹³æŒ‡å‘å‰ï¼‰:', rotationOffset);
            showFeedback('preset-horizontal-btn', 'âœ“ å·²å¥—ç”¨');
        });


        // å„²å­˜è¨­å®šæŒ‰éˆ•
        document.getElementById('save-settings-btn').addEventListener('click', () => {
            const settings = {
                position: positionOffset,
                rotation: rotationOffset,
                inversion: axisInversion
            };
            localStorage.setItem('drumstick-calibration', JSON.stringify(settings));
            console.log('ğŸ’¾ è¨­å®šå·²å„²å­˜:', settings);
            showFeedback('save-settings-btn', 'ğŸ’¾ å·²å„²å­˜');
        });

        // è¼‰å…¥è¨­å®šæŒ‰éˆ•
        document.getElementById('load-settings-btn').addEventListener('click', () => {
            const saved = localStorage.getItem('drumstick-calibration');
            if (saved) {
                const settings = JSON.parse(saved);
                positionOffset = settings.position;
                rotationOffset = settings.rotation;
                
                // è¼‰å…¥è»¸åè½‰è¨­å®šï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                if (settings.inversion) {
                    axisInversion = settings.inversion;
                }

                // æ›´æ–° UI
                ['x', 'y', 'z'].forEach(axis => {
                    document.getElementById(`offset-${axis}`).value = positionOffset[axis];
                    document.getElementById(`offset-${axis}-input`).value = positionOffset[axis];
                    document.getElementById(`offset-${axis}-value`).textContent = positionOffset[axis].toFixed(1);
                });

                ['roll', 'pitch', 'yaw'].forEach(axis => {
                    document.getElementById(`rotation-${axis}`).value = rotationOffset[axis];
                    document.getElementById(`rotation-${axis}-value`).textContent = rotationOffset[axis];
                    document.getElementById(`invert-${axis}`).checked = axisInversion[axis] || false;
                });

                updateDrumStick();
                console.log('ğŸ“‚ è¨­å®šå·²è¼‰å…¥:', settings);
                showFeedback('load-settings-btn', 'ğŸ“‚ å·²è¼‰å…¥');
            } else {
                alert('æ²’æœ‰æ‰¾åˆ°å„²å­˜çš„è¨­å®š');
            }
        });

        // æŒ‰éˆ•å›é¥‹æ•ˆæœ
        function showFeedback(btnId, text) {
            const btn = document.getElementById(btnId);
            const originalText = btn.textContent;
            btn.textContent = text;
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        // å•Ÿå‹•æ‡‰ç”¨
        window.addEventListener('load', () => {
            init();
            
            // å˜—è©¦è¼‰å…¥å„²å­˜çš„è¨­å®š
            const saved = localStorage.getItem('drumstick-calibration');
            if (saved) {
                const settings = JSON.parse(saved);
                positionOffset = settings.position;
                rotationOffset = settings.rotation;
                
                // è¼‰å…¥è»¸åè½‰è¨­å®šï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                if (settings.inversion) {
                    axisInversion = settings.inversion;
                    
                    // æ›´æ–°è¤‡é¸æ¡†ç‹€æ…‹
                    ['roll', 'pitch', 'yaw'].forEach(axis => {
                        document.getElementById(`invert-${axis}`).checked = axisInversion[axis] || false;
                    });
                }
                
                console.log('ğŸ“‚ è‡ªå‹•è¼‰å…¥è¨­å®š:', settings);
            }
        });
    </script>
</body>
</html>
