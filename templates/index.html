<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Drumstick Visualizer</title>
    <style>
        body { background: #222; display: flex; justify-content: center; }
        canvas { background: #fff; margin-top: 20px; }
    </style>
</head>
<body>

<canvas id="drumCanvas" width="900" height="450"></canvas>
<button onclick="enableAudio()" style="position:fixed; top:20px; left:20px;">
    üîä Enable Drum Sound
</button>

<script>

// --------------------- AudioContext ÂàùÂßãÂåñ ---------------------
let audioCtx;
let buffers = {};

async function enableAudio() {
    if (audioCtx) {
        alert("Audio already enabled!");
        return;
    }

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const files = {
        "Symbal": "/sounds/symbal.wav",
        "Tom_high": "/sounds/tom_high.wav",
        "Tom_mid": "/sounds/tom_mid.wav",
        "Ride": "/sounds/ride.wav",
        "Hihat": "/sounds/hihat.wav",
        "Snare": "/sounds/snare.wav",
        "Tom_floor": "/sounds/tom_floor.wav",
    };

    for (const key in files) {
        const res = await fetch(files[key]);
        const arr = await res.arrayBuffer();
        buffers[key] = await audioCtx.decodeAudioData(arr);
    }

    alert("Audio Enabled! ü•Å Sounds ready!");
}

function playSound(name) {
    if (!audioCtx || !buffers[name]) return;
    const src = audioCtx.createBufferSource();
    src.buffer = buffers[name];
    src.connect(audioCtx.destination);
    src.start(0);
}


// --------------------- Áï´Â∏É ---------------------
const canvas = document.getElementById("drumCanvas");
const ctx = canvas.getContext("2d");

const zones = [
    { name: "Symbal",    x: 0,   y: 0,   w: 225, h: 225, color:"#e5b3ff" },
    { name: "Tom_high",  x: 225, y: 0,   w: 225, h: 225, color:"#00c864" },
    { name: "Tom_mid",   x: 450, y: 0,   w: 225, h: 225, color:"#ff7f2a" },
    { name: "Ride",      x: 675, y: 0,   w: 225, h: 225, color:"#6eeee7" },

    { name: "Hihat",     x: 0,   y: 225, w: 225, h: 225, color:"#3232ff" },
    { name: "Snare",     x: 225, y: 225, w: 225, h: 225, color:"#d9d9d9" },
    { name: "Snare",     x: 450, y: 225, w: 225, h: 225, color:"#d9d9d9" },
    { name: "Tom_floor", x: 675, y: 225, w: 225, h: 225, color:"#4d4d4d" },
];

function mapAngleToXY(pitch, roll) {
    let x = (roll + 90) / 180 * canvas.width;
    let y = (pitch + 60) / 120 * canvas.height;
    x = Math.max(0, Math.min(canvas.width, x));
    y = Math.max(0, Math.min(canvas.height, y));
    return {x, y};
}

function draw(pitch, roll) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    zones.forEach(z => {
        ctx.fillStyle = z.color;
        ctx.fillRect(z.x, z.y, z.w, z.h);

        ctx.fillStyle = "#fff";
        ctx.font = "20px Arial";
        ctx.fillText(z.name, z.x + 10, z.y + 30);
    });

    const pos = mapAngleToXY(pitch, roll);
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
    ctx.fill();
}


// --------------------- HIT ÂÅµÊ∏¨ ---------------------
let hitCooldown = 0;

function detectZone(pitch, roll) {
    if (roll < -20) return "Hihat";
    if (roll > 20) return "Ride";
    return "Snare";
}

function detectHit(ax, ay, az, gy, gz) {
    const fastSwing = Math.abs(gy) > 70 || Math.abs(gz) > 70;
    const downward = az > 9.2;
    return fastSwing && downward;
}


// --------------------- ‰∏ªËø¥Âúà ---------------------
function update() {
    fetch("/data")
        .then(res => res.json())
        .then(d => {
            draw(d.pitch, d.roll);

            if (hitCooldown > 0) {
                hitCooldown--;
                return;
            }

            if (detectHit(d.ax, d.ay, d.az, d.gy, d.gz)) {
                let zone = detectZone(d.pitch, d.roll);
                playSound(zone);
                hitCooldown = 6;
            }
        })
        .catch(err => console.log("Fetch error:", err));

    requestAnimationFrame(update);
}

update();

</script>




</body>
</html>
