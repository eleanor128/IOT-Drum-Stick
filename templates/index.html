<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Drumstick Visualizer</title>
    <style>
        body {
            background: #222;
            display: flex;
            justify-content: center;
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
        }
        canvas { background: #fff; margin-top: 20px; }

        /* æ•¸æ“šé¡¯ç¤ºé¢æ¿ */
        .sensor-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #4fc3f7;
            border-radius: 10px;
            padding: 15px;
            color: white;
            min-width: 280px;
            backdrop-filter: blur(10px);
        }

        .sensor-panel h3 {
            margin: 0 0 10px 0;
            color: #4fc3f7;
            font-size: 16px;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 5px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 13px;
        }

        .data-label {
            color: #aaa;
        }

        .data-value {
            color: #4fc3f7;
            font-weight: bold;
        }

        .section-divider {
            height: 1px;
            background: #444;
            margin: 10px 0;
        }

        /* éŸ³æ•ˆå•Ÿå‹•æŒ‰éˆ• */
        .audio-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .audio-button:hover {
            background: #0288d1;
            transform: scale(1.05);
        }

        .audio-button.enabled {
            background: #4caf50;
        }

        .status-text {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #4fc3f7;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<button id="enableAudioBtn" class="audio-button" onclick="enableAudio()">ğŸ”Š å•Ÿå‹•éŸ³æ•ˆ</button>
<div id="statusText" class="status-text">è«‹é»æ“Šã€Œå•Ÿå‹•éŸ³æ•ˆã€æŒ‰éˆ•</div>

<canvas id="drumCanvas" width="900" height="450"></canvas>

<!-- æ„Ÿæ¸¬å™¨æ•¸æ“šé¡¯ç¤ºé¢æ¿ -->
<div class="sensor-panel">
    <h3>ğŸ“Š æ„Ÿæ¸¬å™¨æ•¸æ“š (å³æ‰‹)</h3>

    <div class="data-row">
        <span class="data-label">Pitch (ä¿¯ä»°):</span>
        <span class="data-value" id="pitch-value">0.0Â°</span>
    </div>
    <div class="data-row">
        <span class="data-label">Roll (æ©«æ»¾):</span>
        <span class="data-value" id="roll-value">0.0Â°</span>
    </div>
    <div class="data-row">
        <span class="data-label">Yaw (åèˆª):</span>
        <span class="data-value" id="yaw-value">0.0Â°</span>
    </div>

    <div class="section-divider"></div>

    <div class="data-row">
        <span class="data-label">åŠ é€Ÿåº¦ X:</span>
        <span class="data-value" id="accel-x-value">0.00 g</span>
    </div>
    <div class="data-row">
        <span class="data-label">åŠ é€Ÿåº¦ Y:</span>
        <span class="data-value" id="accel-y-value">0.00 g</span>
    </div>
    <div class="data-row">
        <span class="data-label">åŠ é€Ÿåº¦ Z:</span>
        <span class="data-value" id="accel-z-value">0.00 g</span>
    </div>
    <div class="data-row">
        <span class="data-label">ç¸½åŠ é€Ÿåº¦:</span>
        <span class="data-value" id="magnitude-value">0.00 g</span>
    </div>

    <div class="section-divider"></div>

    <div class="data-row">
        <span class="data-label">é™€èºå„€ X:</span>
        <span class="data-value" id="gyro-x-value">0.0Â°/s</span>
    </div>
    <div class="data-row">
        <span class="data-label">é™€èºå„€ Y:</span>
        <span class="data-value" id="gyro-y-value">0.0Â°/s</span>
    </div>
    <div class="data-row">
        <span class="data-label">é™€èºå„€ Z:</span>
        <span class="data-value" id="gyro-z-value">0.0Â°/s</span>
    </div>
</div>

<script>

// --------------------- å¤šç¨®éŸ³æ•ˆæ’­æ”¾æ–¹å¼ ---------------------
let audioCtx;
let audioBuffers = {};
let htmlAudioElements = {};
let audioEnabled = false;


// æ–¹æ³• 1: é è¼‰ HTML5 Audio å…ƒç´ ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
// function preloadHTMLAudio() {
//     const soundNames = ["Symbal", "Tom_high", "Tom_mid", "Ride", "Hihat", "Snare", "Tom_floor"];
//     soundNames.forEach(name => {
//         const audio = new Audio(`/static/sounds/${name.toLowerCase()}.wav`);
//         audio.preload = "auto";
//         audio.load();
//         htmlAudioElements[name] = audio;
//     });
//     console.log("HTML5 Audio elements preloaded");
// }

// æ–¹æ³• 2: Web Audio APIï¼ˆä¸»è¦æ–¹æ³•ï¼‰
async function enableAudio() {
    const btn = document.getElementById('enableAudioBtn');
    const status = document.getElementById('statusText');
    
    if (audioEnabled) {
        status.textContent = "éŸ³æ•ˆå·²ç¶“å•Ÿå‹•ï¼";
        return;
    }

    try {
        btn.textContent = "â³ è¼‰å…¥ä¸­...";
        btn.disabled = true;
        
        // åˆå§‹åŒ– AudioContext
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const files = {
            "Symbal": "/static/sounds/symbal.wav",
            "Tom_high": "/static/sounds/tom_high.wav",
            "Tom_mid": "/static/sounds/tom_mid.wav",
            "Ride": "/static/sounds/ride.wav",
            "Hihat": "/static/sounds/hihat.wav",
            "Snare": "/static/sounds/snare.wav",
            "Tom_floor": "/static/sounds/tom_floor.wav",
        };

        // è¼‰å…¥æ‰€æœ‰éŸ³æ•ˆæª”æ¡ˆ
        for (const key in files) {
            try {
                const response = await fetch(files[key]);
                if (!response.ok) {
                    console.error(`Failed to load ${key}: ${response.status}`);
                    continue;
                }
                const arrayBuffer = await response.arrayBuffer();
                audioBuffers[key] = await audioCtx.decodeAudioData(arrayBuffer);
                console.log(`Loaded: ${key}`);
            } catch (err) {
                console.error(`Error loading ${key}:`, err);
            }
        }

        audioEnabled = true;
        btn.textContent = "âœ… éŸ³æ•ˆå·²å•Ÿå‹•";
        btn.classList.add('enabled');
        btn.disabled = false;
        status.textContent = `éŸ³æ•ˆå·²å°±ç·’ï¼å·²è¼‰å…¥ ${Object.keys(audioBuffers).length} å€‹éŸ³æ•ˆ`;
        
        // æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆ
        playSound("Snare");
        
    } catch (error) {
        console.error("Audio initialization failed:", error);
        status.textContent = "éŸ³æ•ˆè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ";
        btn.textContent = "âŒ è¼‰å…¥å¤±æ•—";
        btn.disabled = false;
        
        // ä½¿ç”¨ HTML5 Audio ä½œç‚ºå‚™ç”¨
        preloadHTMLAudio();
        audioEnabled = true;
    }
}

// æ’­æ”¾éŸ³æ•ˆï¼ˆå˜—è©¦å¤šç¨®æ–¹æ³•ï¼‰
function playSound(name) {
    if (!audioEnabled) {
        console.log("Audio not enabled yet");
        return;
    }

    // æ–¹æ³• 1: Web Audio APIï¼ˆå„ªå…ˆï¼‰
    if (audioCtx && audioBuffers[name]) {
        try {
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffers[name];
            
            // æ·»åŠ éŸ³é‡æ§åˆ¶
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.8; // 80% éŸ³é‡
            
            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start(0);
            
            console.log(`Playing: ${name} (Web Audio API)`);
            return;
        } catch (err) {
            console.error(`Web Audio playback error for ${name}:`, err);
        }
    }

    // æ–¹æ³• 2: HTML5 Audioï¼ˆå‚™ç”¨ï¼‰
    if (htmlAudioElements[name]) {
        try {
            const audio = htmlAudioElements[name].cloneNode();
            audio.volume = 0.8;
            audio.play().catch(err => {
                console.error(`HTML5 Audio playback error for ${name}:`, err);
            });
            console.log(`Playing: ${name} (HTML5 Audio)`);
            return;
        } catch (err) {
            console.error(`HTML5 Audio error for ${name}:`, err);
        }
    }

    console.warn(`Could not play sound: ${name}`);
}


// --------------------- ç•«å¸ƒ ---------------------
const canvas = document.getElementById("drumCanvas");
const ctx = canvas.getContext("2d");

const zones = [
    { name: "Symbal",    x: 0,   y: 0,   w: 225, h: 225, color:"#e5b3ff" },
    { name: "Tom_high",  x: 225, y: 0,   w: 225, h: 225, color:"#00c864" },
    { name: "Tom_mid",   x: 450, y: 0,   w: 225, h: 225, color:"#ff7f2a" },
    { name: "Ride",      x: 675, y: 0,   w: 225, h: 225, color:"#6eeee7" },

    { name: "Hihat",     x: 0,   y: 225, w: 225, h: 225, color:"#3232ff" },
    { name: "Snare",     x: 225, y: 225, w: 225, h: 225, color:"#d9d9d9" },
    { name: "Snare",     x: 450, y: 225, w: 225, h: 225, color:"#d9d9d9" },
    { name: "Tom_floor", x: 675, y: 225, w: 225, h: 225, color:"#4d4d4d" },
];

// åœ¨é é¢è¼‰å…¥æ™‚é è¼‰ HTML5 Audioï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
window.addEventListener('load', function() {
    preloadHTMLAudio();
    console.log("Page loaded, HTML5 audio preloaded");
});

function mapAngleToXY(pitch, roll) {
    // X åº§æ¨™ï¼šroll æ§åˆ¶å·¦å³ç§»å‹•ï¼ˆyaw æ•ˆæœï¼‰
    // é¼“æ£’å‘å·¦å‚¾æ–œ â†’ roll ç‚ºè²  â†’ ç´…é»å‘å·¦
    // é¼“æ£’å‘å³å‚¾æ–œ â†’ roll ç‚ºæ­£ â†’ ç´…é»å‘å³
    // roll = -45Â° (å·¦) â†’ x = 0 (å·¦é‚Š)
    // roll = 0Â° (ä¸­) â†’ x = canvas.width / 2 (ä¸­é–“)
    // roll = +45Â° (å³) â†’ x = canvas.width (å³é‚Š)
    let x = (roll + 45) / 90 * canvas.width;


    // Y åº§æ¨™ï¼špitch æ§åˆ¶ä¸Šä¸‹ï¼ˆéœ€è¦åè½‰ï¼‰
    // pitch = +60 (ä¸Š) â†’ y = 0 (é ‚éƒ¨) âœ“
    // pitch = 0 (ä¸­) â†’ y = canvas.height / 2 (ä¸­é–“)
    // pitch = -60 (ä¸‹) â†’ y = canvas.height (åº•éƒ¨) âœ“
    let y = (60 - pitch) / 120 * canvas.height;
    // let y = (45 - pitch) / 90 * canvas.height;


    // é™åˆ¶ç¯„åœåœ¨ç•«å¸ƒå…§
    x = Math.max(0, Math.min(canvas.width, x));
    y = Math.max(0, Math.min(canvas.height, y));
    return {x, y};
}

function draw(pitch, roll) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    zones.forEach(z => {
        ctx.fillStyle = z.color;
        ctx.fillRect(z.x, z.y, z.w, z.h);

        ctx.fillStyle = "#fff";
        ctx.font = "20px Arial";
        ctx.fillText(z.name, z.x + 10, z.y + 30);
    });

    // é¼“æ£’ç´…é»
    const pos = mapAngleToXY(pitch, roll);
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
    ctx.fill();
}


// --------------------- HIT åµæ¸¬ ---------------------
let hitCooldown = 0;

// é¼“é»åç¨±å°æ‡‰è¡¨ï¼ˆhit_detection.py -> index.htmlï¼‰
const drumNameMapping = {
    "Hi-hat": "Hihat",
    "Ride": "Ride",
    "Snare": "Snare",
    "Tom 1": "Tom_high",
    "Tom 2": "Tom_mid",
    "Floor Tom": "Tom_floor",
    "Crash": "Symbal"
};


// --------------------- æ›´æ–°æ•¸æ“šé¡¯ç¤ºé¢æ¿ ---------------------
function updateSensorDisplay(data) {
    // æ›´æ–°è§’åº¦æ•¸æ“š
    document.getElementById('pitch-value').textContent = data["pitch (yè»¸è½‰)"].toFixed(1) + 'Â°';
    document.getElementById('roll-value').textContent = data["roll (xè»¸è½‰)"].toFixed(1) + 'Â°';
    document.getElementById('yaw-value').textContent = data["yaw (zè»¸è½‰)"].toFixed(1) + 'Â°';

    // æ›´æ–°åŠ é€Ÿåº¦æ•¸æ“š
    document.getElementById('accel-x-value').textContent = data.ax.toFixed(2) + ' g';
    document.getElementById('accel-y-value').textContent = data.ay.toFixed(2) + ' g';
    document.getElementById('accel-z-value').textContent = data.az.toFixed(2) + ' g';

    // è¨ˆç®—ç¸½åŠ é€Ÿåº¦
    const magnitude = Math.sqrt(data.ax * data.ax + data.ay * data.ay + data.az * data.az);
    document.getElementById('magnitude-value').textContent = magnitude.toFixed(2) + ' g';

    // æ›´æ–°é™€èºå„€æ•¸æ“š
    document.getElementById('gyro-x-value').textContent = data.gx.toFixed(1) + 'Â°/s';
    document.getElementById('gyro-y-value').textContent = data.gy.toFixed(1) + 'Â°/s';
    document.getElementById('gyro-z-value').textContent = data.gz.toFixed(1) + 'Â°/s';
}


// --------------------- ä¸»è¿´åœˆ ---------------------
function update() {
    fetch("/data")
        .then(res => res.json())
        .then(data => {
            // æ›´æ–°ç•«å¸ƒ
            draw(data["pitch (yè»¸è½‰)"], data["roll (xè»¸è½‰)"]);

            // æ›´æ–°æ•¸æ“šé¡¯ç¤ºé¢æ¿
            updateSensorDisplay(data);

            // ä½¿ç”¨å¾Œç«¯çš„æ•²æ“Šåµæ¸¬çµæœ
            if (hitCooldown > 0) {
                hitCooldown--;
            } else if (data.drum) {
                // å°‡ hit_detection.py çš„é¼“é»åç¨±è½‰æ›ç‚ºéŸ³æ•ˆæª”æ¡ˆåç¨±
                const soundName = drumNameMapping[data.drum];
                if (soundName) {
                    console.log(`ğŸ¥ Hit detected: ${data.drum} -> Playing: ${soundName}`);
                    playSound(soundName);
                    hitCooldown = 8;  // èˆ‡ hit_detection.py ç›¸åŒçš„ cooldown
                }
            }
        })
        .catch(err => console.log("Fetch error:", err));

    requestAnimationFrame(update);
}

update();

</script>




</body>
</html>
