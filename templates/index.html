<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Drumstick Visualizer</title>
    <style>
        body {
            background: #222;
            display: flex;
            justify-content: center;
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
        }
        canvas { background: #fff; margin-top: 20px; }

        /* æ•¸æ“šé¡¯ç¤ºé¢æ¿ */
        .sensor-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #4fc3f7;
            border-radius: 10px;
            padding: 15px;
            color: white;
            min-width: 280px;
            backdrop-filter: blur(10px);
        }

        .sensor-panel h3 {
            margin: 0 0 10px 0;
            color: #4fc3f7;
            font-size: 16px;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 5px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 13px;
        }

        .data-label {
            color: #aaa;
        }

        .data-value {
            color: #4fc3f7;
            font-weight: bold;
        }

        .section-divider {
            height: 1px;
            background: #444;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<canvas id="drumCanvas" width="900" height="450"></canvas>
<button onclick="enableAudio()" style="position:fixed; top:20px; left:20px;">
    ğŸ”Š Enable Drum Sound
</button>

<!-- æ„Ÿæ¸¬å™¨æ•¸æ“šé¡¯ç¤ºé¢æ¿ -->
<div class="sensor-panel">
    <h3>ğŸ“Š æ„Ÿæ¸¬å™¨æ•¸æ“š (å³æ‰‹)</h3>

    <div class="data-row">
        <span class="data-label">Pitch (ä¿¯ä»°):</span>
        <span class="data-value" id="pitch-value">0.0Â°</span>
    </div>
    <div class="data-row">
        <span class="data-label">Roll (æ©«æ»¾):</span>
        <span class="data-value" id="roll-value">0.0Â°</span>
    </div>
    <div class="data-row">
        <span class="data-label">Yaw (åèˆª):</span>
        <span class="data-value" id="yaw-value">0.0Â°</span>
    </div>

    <div class="section-divider"></div>

    <div class="data-row">
        <span class="data-label">åŠ é€Ÿåº¦ X:</span>
        <span class="data-value" id="accel-x-value">0.00 g</span>
    </div>
    <div class="data-row">
        <span class="data-label">åŠ é€Ÿåº¦ Y:</span>
        <span class="data-value" id="accel-y-value">0.00 g</span>
    </div>
    <div class="data-row">
        <span class="data-label">åŠ é€Ÿåº¦ Z:</span>
        <span class="data-value" id="accel-z-value">0.00 g</span>
    </div>
    <div class="data-row">
        <span class="data-label">ç¸½åŠ é€Ÿåº¦:</span>
        <span class="data-value" id="magnitude-value">0.00 g</span>
    </div>

    <div class="section-divider"></div>

    <div class="data-row">
        <span class="data-label">é™€èºå„€ X:</span>
        <span class="data-value" id="gyro-x-value">0.0Â°/s</span>
    </div>
    <div class="data-row">
        <span class="data-label">é™€èºå„€ Y:</span>
        <span class="data-value" id="gyro-y-value">0.0Â°/s</span>
    </div>
    <div class="data-row">
        <span class="data-label">é™€èºå„€ Z:</span>
        <span class="data-value" id="gyro-z-value">0.0Â°/s</span>
    </div>
</div>

<script>

// --------------------- AudioContext åˆå§‹åŒ– ---------------------
let audioCtx;
let buffers = {};

async function enableAudio() {
    if (audioCtx) {
        alert("Audio already enabled!");
        return;
    }

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const files = {
        "Symbal": "static/sounds/symbal.wav",
        "Tom_high": "static/sounds/tom_high.wav",
        "Tom_mid": "static/sounds/tom_mid.wav",
        "Ride": "static/sounds/ride.wav",
        "Hihat": "static/sounds/hihat.wav",
        "Snare": "static/sounds/snare.wav",
        "Tom_floor": "static/sounds/tom_floor.wav",
    };

    for (const key in files) {
        const res = await fetch(files[key]);
        const arr = await res.arrayBuffer();
        buffers[key] = await audioCtx.decodeAudioData(arr);
    }

    alert("Audio Enabled! ğŸ¥ Sounds ready!");
}

function playSound(name) {
    if (!audioCtx || !buffers[name]) return;
    const src = audioCtx.createBufferSource();
    src.buffer = buffers[name];
    src.connect(audioCtx.destination);
    src.start(0);
}


// --------------------- ç•«å¸ƒ ---------------------
const canvas = document.getElementById("drumCanvas");
const ctx = canvas.getContext("2d");

const zones = [
    { name: "Symbal",    x: 0,   y: 0,   w: 225, h: 225, color:"#e5b3ff" },
    { name: "Tom_high",  x: 225, y: 0,   w: 225, h: 225, color:"#00c864" },
    { name: "Tom_mid",   x: 450, y: 0,   w: 225, h: 225, color:"#ff7f2a" },
    { name: "Ride",      x: 675, y: 0,   w: 225, h: 225, color:"#6eeee7" },

    { name: "Hihat",     x: 0,   y: 225, w: 225, h: 225, color:"#3232ff" },
    { name: "Snare",     x: 225, y: 225, w: 225, h: 225, color:"#d9d9d9" },
    { name: "Snare",     x: 450, y: 225, w: 225, h: 225, color:"#d9d9d9" },
    { name: "Tom_floor", x: 675, y: 225, w: 225, h: 225, color:"#4d4d4d" },
];

function mapAngleToXY(pitch, roll) {
    // X åº§æ¨™ï¼šroll æ§åˆ¶å·¦å³ç§»å‹•ï¼ˆyaw æ•ˆæœï¼‰
    // é¼“æ£’å‘å·¦å‚¾æ–œ â†’ roll ç‚ºè²  â†’ ç´…é»å‘å·¦
    // é¼“æ£’å‘å³å‚¾æ–œ â†’ roll ç‚ºæ­£ â†’ ç´…é»å‘å³
    // roll = -45Â° (å·¦) â†’ x = 0 (å·¦é‚Š)
    // roll = 0Â° (ä¸­) â†’ x = canvas.width / 2 (ä¸­é–“)
    // roll = +45Â° (å³) â†’ x = canvas.width (å³é‚Š)
    let x = (roll + 45) / 90 * canvas.width;


    // Y åº§æ¨™ï¼špitch æ§åˆ¶ä¸Šä¸‹ï¼ˆéœ€è¦åè½‰ï¼‰
    // pitch = +60 (ä¸Š) â†’ y = 0 (é ‚éƒ¨) âœ“
    // pitch = 0 (ä¸­) â†’ y = canvas.height / 2 (ä¸­é–“)
    // pitch = -60 (ä¸‹) â†’ y = canvas.height (åº•éƒ¨) âœ“
    let y = (60 - pitch) / 120 * canvas.height;
    // let y = (45 - pitch) / 90 * canvas.height;


    // é™åˆ¶ç¯„åœåœ¨ç•«å¸ƒå…§
    x = Math.max(0, Math.min(canvas.width, x));
    y = Math.max(0, Math.min(canvas.height, y));
    return {x, y};
}

function draw(pitch, roll) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    zones.forEach(z => {
        ctx.fillStyle = z.color;
        ctx.fillRect(z.x, z.y, z.w, z.h);

        ctx.fillStyle = "#fff";
        ctx.font = "20px Arial";
        ctx.fillText(z.name, z.x + 10, z.y + 30);
    });

    // é¼“æ£’ç´…é»
    const pos = mapAngleToXY(pitch, roll);
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
    ctx.fill();
}


// --------------------- HIT åµæ¸¬ ---------------------
let hitCooldown = 0;

function detectZone(pitch, roll) {
    // æ ¹æ“š pitch å’Œ roll è¨ˆç®—ç´…é»çš„ X, Y åº§æ¨™
    const pos = mapAngleToXY(pitch, roll);

    // æª¢æŸ¥ç´…é»ä½æ–¼å“ªå€‹å€å¡Š
    for (const zone of zones) {
        if (pos.x >= zone.x && pos.x < zone.x + zone.w &&
            pos.y >= zone.y && pos.y < zone.y + zone.h) {
            return zone.name;
        }
    }

    // é è¨­è¿”å› Snareï¼ˆå¦‚æœæ²’æœ‰åŒ¹é…åˆ°ä»»ä½•å€å¡Šï¼‰
    return "Snare";
}

function detectHit(ax, ay, az, gy, gz) {
    // åµæ¸¬å¿«é€Ÿæ®å‹• + å‘ä¸‹åŠ é€Ÿåº¦
    const fastSwing = Math.abs(gy) > 70 || Math.abs(gz) > 70;
    const downward = az > 9.2;
    return fastSwing && downward;
}


// --------------------- æ›´æ–°æ•¸æ“šé¡¯ç¤ºé¢æ¿ ---------------------
function updateSensorDisplay(data) {
    // æ›´æ–°è§’åº¦æ•¸æ“š
    document.getElementById('pitch-value').textContent = data["pitch (yè»¸è½‰)"].toFixed(1) + 'Â°';
    document.getElementById('roll-value').textContent = data["roll (xè»¸è½‰)"].toFixed(1) + 'Â°';
    document.getElementById('yaw-value').textContent = data["yaw (zè»¸è½‰)"].toFixed(1) + 'Â°';

    // æ›´æ–°åŠ é€Ÿåº¦æ•¸æ“š
    document.getElementById('accel-x-value').textContent = data.ax.toFixed(2) + ' g';
    document.getElementById('accel-y-value').textContent = data.ay.toFixed(2) + ' g';
    document.getElementById('accel-z-value').textContent = data.az.toFixed(2) + ' g';

    // è¨ˆç®—ç¸½åŠ é€Ÿåº¦
    const magnitude = Math.sqrt(data.ax * data.ax + data.ay * data.ay + data.az * data.az);
    document.getElementById('magnitude-value').textContent = magnitude.toFixed(2) + ' g';

    // æ›´æ–°é™€èºå„€æ•¸æ“š
    document.getElementById('gyro-x-value').textContent = data.gx.toFixed(1) + 'Â°/s';
    document.getElementById('gyro-y-value').textContent = data.gy.toFixed(1) + 'Â°/s';
    document.getElementById('gyro-z-value').textContent = data.gz.toFixed(1) + 'Â°/s';
}

// --------------------- ä¸»è¿´åœˆ ---------------------
function update() {
    fetch("/data")
        .then(res => res.json())
        .then(data => {
            // æ›´æ–°ç•«å¸ƒ
            draw(data["pitch (yè»¸è½‰)"], data["roll (xè»¸è½‰)"]);

            // æ›´æ–°æ•¸æ“šé¡¯ç¤ºé¢æ¿
            updateSensorDisplay(data);

            if (hitCooldown > 0) {
                hitCooldown--;
                return;
            }

            if (detectHit(data.ax, data.ay, data.az, data.gy, data.gz)) {
                let zone = detectZone(data["pitch (yè»¸è½‰)"], data["roll (xè»¸è½‰)"]);
                playSound(zone);
                hitCooldown = 6;
            }
        })
        .catch(err => console.log("Fetch error:", err));

    requestAnimationFrame(update);
}

update();

</script>




</body>
</html>
