<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ ¡æº– - MPU6050 é¼“æ£’è¦–è¦ºåŒ–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #header h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        #status-bar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .status-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        .status-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 18px;
            font-weight: bold;
        }

        #position-indicator {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 16px;
            padding: 12px 25px;
        }

        #main-container {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 20px;
        }

        #canvas-container {
            flex: 3;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #controls-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .preset-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        .calibration-info {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .calibration-info h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .calibration-info p {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin: 5px 0;
        }

        .calibration-values {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .cal-value {
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .cal-value .label {
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .cal-value .value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        #mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-btn:hover:not(.active) {
            background: #f0f4ff;
        }

        .info-box {
            background: #fff9e6;
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .info-box .title {
            font-weight: bold;
            color: #ff8c00;
            margin-bottom: 6px;
        }

        .info-box .content {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ğŸ¥ æ™ºèƒ½æ ¡æº–ç³»çµ±</h1>
        <div id="status-bar">
            <div class="status-item">
                <span class="status-label">Roll (ç¿»æ»¾)</span>
                <span class="status-value" id="roll-display">0.0Â°</span>
            </div>
            <div class="status-item">
                <span class="status-label">Pitch (ä¿¯ä»°)</span>
                <span class="status-value" id="pitch-display">0.0Â°</span>
            </div>
            <div class="status-item">
                <span class="status-label">Yaw (åèˆª)</span>
                <span class="status-value" id="yaw-display">0.0Â°</span>
            </div>
            <div class="status-item" id="position-indicator">
                <span class="status-label">åµæ¸¬ä½ç½®</span>
                <span class="status-value" id="position-display">---</span>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="canvas-container">
            <div id="three-canvas"></div>
        </div>

        <div id="controls-panel">
            <div class="control-section">
                <h3>ğŸ¯ æ ¡æº–æ¨¡å¼</h3>
                <div id="mode-toggle">
                    <button class="mode-btn active" onclick="setMode('auto')">è‡ªå‹•æ ¡æº–</button>
                    <button class="mode-btn" onclick="setMode('manual')">æ‰‹å‹•æ ¡æº–</button>
                </div>
                <div class="info-box">
                    <div class="title">ğŸ’¡ æ¨¡å¼èªªæ˜</div>
                    <div class="content">
                        <strong>è‡ªå‹•æ¨¡å¼:</strong> æ ¹æ“š Yaw å€¼è‡ªå‹•åˆ¤æ–·ä½ç½®ä¸¦å¥—ç”¨å°æ‡‰æ ¡æº–<br>
                        <strong>æ‰‹å‹•æ¨¡å¼:</strong> ä½¿ç”¨å›ºå®šçš„æ ¡æº–åƒæ•¸
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>ğŸ“Š ä½ç½®åˆ¤æ–·åŸºæº–</h3>
                <div class="calibration-info">
                    <h4>Yaw ç¯„åœå®šç¾©</h4>
                    <p><strong>Center:</strong> 15Â° ~ 28Â° (ä¸­ä½æ•¸: 21.60Â°)</p>
                    <p><strong>Left:</strong> 28Â° ~ 38Â° (ä¸­ä½æ•¸: 34.53Â°)</p>
                    <p><strong>Right:</strong> 5Â° ~ 15Â° (ä¸­ä½æ•¸: 9.02Â°)</p>
                </div>
            </div>

            <div class="control-section">
                <h3>ğŸ›ï¸ ä½ç½®å°ˆç”¨æ ¡æº–å€¼</h3>
                
                <div class="calibration-info">
                    <h4>CENTER (æ­£å‰æ–¹)</h4>
                    <div class="calibration-values">
                        <div class="cal-value">
                            <div class="label">Roll</div>
                            <div class="value">-8.68Â°</div>
                        </div>
                        <div class="cal-value">
                            <div class="label">Pitch</div>
                            <div class="value">-69.77Â°</div>
                        </div>
                        <div class="cal-value">
                            <div class="label">Yaw</div>
                            <div class="value">-21.60Â°</div>
                        </div>
                    </div>
                </div>

                <div class="calibration-info">
                    <h4>LEFT (å·¦æ–¹)</h4>
                    <div class="calibration-values">
                        <div class="cal-value">
                            <div class="label">Roll</div>
                            <div class="value">21.76Â°</div>
                        </div>
                        <div class="cal-value">
                            <div class="label">Pitch</div>
                            <div class="value">-77.64Â°</div>
                        </div>
                        <div class="cal-value">
                            <div class="label">Yaw</div>
                            <div class="value">-124.53Â°</div>
                        </div>
                    </div>
                </div>

                <div class="calibration-info">
                    <h4>RIGHT (å³æ–¹)</h4>
                    <div class="calibration-values">
                        <div class="cal-value">
                            <div class="label">Roll</div>
                            <div class="value">-40.45Â°</div>
                        </div>
                        <div class="cal-value">
                            <div class="label">Pitch</div>
                            <div class="value">-78.42Â°</div>
                        </div>
                        <div class="cal-value">
                            <div class="label">Yaw</div>
                            <div class="value">80.98Â°</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>ğŸ”„ å¿«é€Ÿé è¨­</h3>
                <div class="preset-buttons">
                    <button class="btn btn-success" onclick="applyPositionCalibration('center')">
                        å¥—ç”¨ CENTER æ ¡æº–
                    </button>
                    <button class="btn btn-success" onclick="applyPositionCalibration('left')">
                        å¥—ç”¨ LEFT æ ¡æº–
                    </button>
                    <button class="btn btn-success" onclick="applyPositionCalibration('right')">
                        å¥—ç”¨ RIGHT æ ¡æº–
                    </button>
                    <button class="btn btn-warning" onclick="resetCalibration()">
                        é‡ç½®æ ¡æº–
                    </button>
                </div>
            </div>

            <div class="control-section">
                <h3>ğŸ“– ä½¿ç”¨èªªæ˜</h3>
                <div class="info-box">
                    <div class="content">
                        1. <strong>è‡ªå‹•æ¨¡å¼:</strong> ç³»çµ±æœƒæ ¹æ“š Yaw å€¼è‡ªå‹•åˆ¤æ–·é¼“æ£’ä½ç½®<br>
                        2. <strong>è§€å¯Ÿé¡¯ç¤º:</strong> æª¢æŸ¥ç•«é¢ä¸Šçš„é¼“æ£’æ–¹å‘æ˜¯å¦æ­£ç¢º<br>
                        3. <strong>æ‰‹å‹•èª¿æ•´:</strong> å¦‚éœ€å¾®èª¿,å¯åˆ‡æ›åˆ°æ‰‹å‹•æ¨¡å¼<br>
                        4. <strong>Zè»¸æ“Šé¼“é–¾å€¼:</strong> 34.83 m/sÂ² (å»ºè­°å€¼)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ==================== é…ç½®å€ ====================
        // åŸºæ–¼ 1730 å€‹æ¨£æœ¬çš„æ•¸æ“šåˆ†æçµæœ (2025-12-02)
        const CALIBRATION_PROFILES = {
            center: { roll: -8.68, pitch: -69.77, yaw: -21.60 },
            left:   { roll: 21.76, pitch: -77.64, yaw: -124.53 },
            right:  { roll: -40.45, pitch: -78.42, yaw: 80.98 }
        };

        const YAW_RANGES = {
            center: { min: 15, max: 28 },
            left:   { min: 28, max: 38 },
            right:  { min: 5,  max: 15 }
        };

        let calibrationMode = 'auto'; // 'auto' or 'manual'
        let currentCalibration = { roll: 0, pitch: 0, yaw: 0 };

        // ==================== Three.js å ´æ™¯è¨­ç½® ====================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);

        const camera = new THREE.PerspectiveCamera(
            60,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(0, 2, 10);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        const container = document.getElementById('three-canvas');
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // æ·»åŠ å…‰æº
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        // å‰µå»ºåœ°æ¿ç¶²æ ¼
        const gridHelper = new THREE.GridHelper(10, 10);
        scene.add(gridHelper);

        // å‰µå»ºåº§æ¨™è»¸
        const axesHelper = new THREE.AxesHelper(3);
        scene.add(axesHelper);

        // å‰µå»ºé¼“
        const drumGeometry = new THREE.CylinderGeometry(1, 1, 0.5, 32);
        const drumMaterial = new THREE.MeshPhongMaterial({ 
            color: 0x8b4513,
            shininess: 30
        });
        const drum = new THREE.Mesh(drumGeometry, drumMaterial);
        drum.position.set(0, 0.25, 0);
        scene.add(drum);

        // å‰µå»ºé¼“é¢
        const drumTopGeometry = new THREE.CircleGeometry(1, 32);
        const drumTopMaterial = new THREE.MeshPhongMaterial({ 
            color: 0xf5f5dc,
            side: THREE.DoubleSide
        });
        const drumTop = new THREE.Mesh(drumTopGeometry, drumTopMaterial);
        drumTop.rotation.x = -Math.PI / 2;
        drumTop.position.set(0, 0.5, 0);
        scene.add(drumTop);

        // å‰µå»ºé¼“æ£’
        const stickGeometry = new THREE.CylinderGeometry(0.05, 0.05, 2, 16);
        const stickMaterial = new THREE.MeshPhongMaterial({ color: 0xcd853f });
        const drumStick = new THREE.Mesh(stickGeometry, stickMaterial);

        // é¼“æ£’å°–ç«¯ (ç´…è‰²æ¨™è¨˜)
        const tipGeometry = new THREE.SphereGeometry(0.08, 16, 16);
        const tipMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
        const drumStickTip = new THREE.Mesh(tipGeometry, tipMaterial);
        drumStickTip.position.y = 1;
        drumStick.add(drumStickTip);

        drumStick.position.set(0, 3, 0);
        drumStick.rotation.order = 'YXZ';
        scene.add(drumStick);

        // ==================== ä½ç½®åˆ¤æ–·å‡½æ•¸ ====================
        function detectPosition(yaw) {
            // æ ¹æ“š Yaw å€¼åˆ¤æ–·ä½ç½®
            if (yaw >= YAW_RANGES.left.min && yaw <= YAW_RANGES.left.max) {
                return 'left';
            } else if (yaw >= YAW_RANGES.right.min && yaw <= YAW_RANGES.right.max) {
                return 'right';
            } else if (yaw >= YAW_RANGES.center.min && yaw <= YAW_RANGES.center.max) {
                return 'center';
            } else {
                // è¶…å‡ºç¯„åœ,é¸æ“‡æœ€æ¥è¿‘çš„
                const distances = {
                    center: Math.min(
                        Math.abs(yaw - YAW_RANGES.center.min),
                        Math.abs(yaw - YAW_RANGES.center.max)
                    ),
                    left: Math.min(
                        Math.abs(yaw - YAW_RANGES.left.min),
                        Math.abs(yaw - YAW_RANGES.left.max)
                    ),
                    right: Math.min(
                        Math.abs(yaw - YAW_RANGES.right.min),
                        Math.abs(yaw - YAW_RANGES.right.max)
                    )
                };
                return Object.keys(distances).reduce((a, b) => 
                    distances[a] < distances[b] ? a : b
                );
            }
        }

        function updatePositionDisplay(position) {
            const display = document.getElementById('position-display');
            const indicator = document.getElementById('position-indicator');
            
            const labels = {
                center: 'æ­£å‰æ–¹ â¬†ï¸',
                left: 'å·¦æ–¹ â¬…ï¸',
                right: 'å³æ–¹ â¡ï¸'
            };
            
            display.textContent = labels[position] || 'æœªçŸ¥';
            
            // æ›´æ–°é¡è‰²
            if (position === 'center') {
                indicator.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
            } else if (position === 'left') {
                indicator.style.background = 'linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%)';
            } else if (position === 'right') {
                indicator.style.background = 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)';
            }
        }

        // ==================== æ ¡æº–å‡½æ•¸ ====================
        function applyCalibration(profile) {
            currentCalibration = { ...profile };
            console.log('å¥—ç”¨æ ¡æº–:', currentCalibration);
        }

        function applyPositionCalibration(position) {
            if (CALIBRATION_PROFILES[position]) {
                applyCalibration(CALIBRATION_PROFILES[position]);
                updatePositionDisplay(position);
                alert(`å·²å¥—ç”¨ ${position.toUpperCase()} ä½ç½®æ ¡æº–`);
            }
        }

        function resetCalibration() {
            currentCalibration = { roll: 0, pitch: 0, yaw: 0 };
            console.log('æ ¡æº–å·²é‡ç½®');
            alert('æ ¡æº–å·²é‡ç½®');
        }

        function setMode(mode) {
            calibrationMode = mode;
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('åˆ‡æ›æ¨¡å¼:', mode);
        }

        // ==================== å§¿æ…‹æ›´æ–°å‡½æ•¸ ====================
        function updateDrumStick(roll, pitch, yaw) {
            // é¡¯ç¤ºåŸå§‹æ•¸æ“š
            document.getElementById('roll-display').textContent = roll.toFixed(1) + 'Â°';
            document.getElementById('pitch-display').textContent = pitch.toFixed(1) + 'Â°';
            document.getElementById('yaw-display').textContent = yaw.toFixed(1) + 'Â°';

            // è‡ªå‹•æ¨¡å¼: æ ¹æ“š Yaw åˆ¤æ–·ä½ç½®ä¸¦å¥—ç”¨æ ¡æº–
            if (calibrationMode === 'auto') {
                const position = detectPosition(yaw);
                updatePositionDisplay(position);
                currentCalibration = { ...CALIBRATION_PROFILES[position] };
            }

            // å¥—ç”¨æ ¡æº–åç§»
            const calibratedRoll = roll + currentCalibration.roll;
            const calibratedPitch = pitch + currentCalibration.pitch;
            const calibratedYaw = yaw + currentCalibration.yaw;

            // è½‰æ›ç‚ºå¼§åº¦
            const rollRad = THREE.MathUtils.degToRad(calibratedRoll);
            const pitchRad = THREE.MathUtils.degToRad(calibratedPitch);
            const yawRad = THREE.MathUtils.degToRad(calibratedYaw);

            // å¥—ç”¨æ—‹è½‰ (YXZ é †åº)
            drumStick.rotation.set(pitchRad, yawRad, rollRad);
        }

        // ==================== Socket.IO é€£æ¥ ====================
        const socket = io();

        socket.on('connect', () => {
            console.log('âœ… å·²é€£æ¥åˆ°ä¼ºæœå™¨');
        });

        socket.on('sensor_data', (data) => {
            updateDrumStick(data.roll, data.pitch, data.yaw);
        });

        socket.on('disconnect', () => {
            console.log('âŒ èˆ‡ä¼ºæœå™¨æ–·ç·š');
        });

        // ==================== å‹•ç•«å¾ªç’° ====================
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // ==================== è¦–çª—å¤§å°èª¿æ•´ ====================
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        // åˆå§‹åŒ–
        console.log('ğŸ¯ æ™ºèƒ½æ ¡æº–ç³»çµ±å·²è¼‰å…¥');
        console.log('æ ¡æº–é…ç½®:', CALIBRATION_PROFILES);
        console.log('Yaw ç¯„åœ:', YAW_RANGES);
    </script>
</body>
</html>
