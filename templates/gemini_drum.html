<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D æ™ºèƒ½é¼“æ£’å³æ™‚è¦–è¦ºåŒ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- ==================== CSS æ¨£å¼å€ ==================== -->
    <style>
        /* === åŸºç¤æ¨£å¼ === */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0d0d0d;
        }
        #scene-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        canvas {
            display: block;
        }

        /* === å·¦å´è³‡è¨Šé¢æ¿æ¨£å¼ === */
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            max-width: 350px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        #info-panel::-webkit-scrollbar {
            width: 8px;
        }
        #info-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        #info-panel::-webkit-scrollbar-thumb {
            background: rgba(14, 165, 233, 0.5);
            border-radius: 4px;
        }
        #info-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(14, 165, 233, 0.8);
        }
        .info-row {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .info-label {
            color: #888;
            margin-right: 10px;
        }
        .info-value {
            color: #0ea5e9;
            font-weight: bold;
        }
        .position-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .pos-left { background: #f59e0b; color: white; }
        .pos-center { background: #10b981; color: white; }
        .pos-right { background: #3b82f6; color: white; }
        .pos-none { background: #6b7280; color: white; }

        /* === å³å´ Offset æ§åˆ¶é¢æ¿æ¨£å¼ === */
        #offset-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 13px;
            max-width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        #offset-panel::-webkit-scrollbar {
            width: 6px;
        }
        #offset-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        #offset-panel::-webkit-scrollbar-thumb {
            background: rgba(79, 195, 247, 0.5);
            border-radius: 3px;
        }
        #offset-panel h3 {
            margin: 15px 0 10px 0;
            font-size: 14px;
            color: #4fc3f7;
            border-bottom: 1px solid #4fc3f7;
            padding-bottom: 5px;
        }
        .offset-input-row {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .offset-input-row label {
            min-width: 80px;
            color: #aaa;
        }
        .offset-input-row input {
            flex: 1;
            padding: 5px 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }
        .offset-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: transform 0.2s;
        }
        .offset-btn:hover {
            transform: translateY(-2px);
        }
        .offset-btn-reset {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .axis-legend {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        .axis-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 12px;
        }
        .axis-color-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        .axis-x { background: #ff0000; }
        .axis-y { background: #00ff00; }
        .axis-z { background: #0000ff; }

        /* === åº•éƒ¨ç‹€æ…‹åˆ—æ¨£å¼ === */
        #status-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: bold;
        }
    </style>
</head>

<!-- ==================== HTML çµæ§‹å€ ==================== -->
<body>
    <div id="scene-container"></div>

    <!-- å·¦å´ï¼šå³æ™‚æ•¸æ“šé¡¯ç¤ºé¢æ¿ -->
    <div id="info-panel">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #fff;">
            ğŸ¥ å³æ™‚é¼“æ£’è¿½è¹¤
        </div>

        <!-- å·¦æ‰‹é¼“æ£’æ•¸æ“š -->
        <div style="margin-bottom: 10px; color: #fbbf24;">ğŸ‘ˆ å·¦æ‰‹é¼“æ£’</div>
        <div class="info-row">
            <span class="info-label">ä½ç½®:</span>
            <span id="left-position" class="position-indicator pos-none">---</span>
        </div>
        <div class="info-row">
            <span class="info-label">ä¿¯ä»°è§’ (Pitch):</span>
            <span class="info-value" id="left-pitch">0Â°</span>
        </div>
        <div class="info-row">
            <span class="info-label">ç¿»æ»¾è§’ (Roll):</span>
            <span class="info-value" id="left-roll">0Â°</span>
        </div>
        <div class="info-row">
            <span class="info-label">ç¸½åŠ é€Ÿåº¦:</span>
            <span class="info-value" id="left-accel">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">åŠ é€Ÿåº¦ X:</span>
            <span class="info-value" id="left-accel-x">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">åŠ é€Ÿåº¦ Y:</span>
            <span class="info-value" id="left-accel-y">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">åŠ é€Ÿåº¦ Z:</span>
            <span class="info-value" id="left-accel-z">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">é™€èºå„€ X:</span>
            <span class="info-value" id="left-gyro-x">0.0Â°/s</span>
        </div>
        <div class="info-row">
            <span class="info-label">é™€èºå„€ Y:</span>
            <span class="info-value" id="left-gyro-y">0.0Â°/s</span>
        </div>
        <div class="info-row">
            <span class="info-label">é™€èºå„€ Z:</span>
            <span class="info-value" id="left-gyro-z">0.0Â°/s</span>
        </div>

        <!-- å³æ‰‹é¼“æ£’æ•¸æ“š -->
        <div style="margin: 15px 0 10px 0; color: #60a5fa;">ğŸ‘‰ å³æ‰‹é¼“æ£’</div>
        <div class="info-row">
            <span class="info-label">ä½ç½®:</span>
            <span id="right-position" class="position-indicator pos-none">---</span>
        </div>
        <div class="info-row">
            <span class="info-label">ä¿¯ä»°è§’ (Pitch):</span>
            <span class="info-value" id="right-pitch">0Â°</span>
        </div>
        <div class="info-row">
            <span class="info-label">ç¿»æ»¾è§’ (Roll):</span>
            <span class="info-value" id="right-roll">0Â°</span>
        </div>
        <div class="info-row">
            <span class="info-label">ç¸½åŠ é€Ÿåº¦:</span>
            <span class="info-value" id="right-accel">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">åŠ é€Ÿåº¦ X:</span>
            <span class="info-value" id="right-accel-x">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">åŠ é€Ÿåº¦ Y:</span>
            <span class="info-value" id="right-accel-y">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">åŠ é€Ÿåº¦ Z:</span>
            <span class="info-value" id="right-accel-z">0.00 g</span>
        </div>
        <div class="info-row">
            <span class="info-label">é™€èºå„€ X:</span>
            <span class="info-value" id="right-gyro-x">0.0Â°/s</span>
        </div>
        <div class="info-row">
            <span class="info-label">é™€èºå„€ Y:</span>
            <span class="info-value" id="right-gyro-y">0.0Â°/s</span>
        </div>
        <div class="info-row">
            <span class="info-label">é™€èºå„€ Z:</span>
            <span class="info-value" id="right-gyro-z">0.0Â°/s</span>
        </div>
    </div>

    <!-- å³å´ï¼šæ„Ÿæ¸¬å™¨ Offset æ§åˆ¶é¢æ¿ -->
    <div id="offset-panel">
        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #fff;">
            âš™ï¸ æ„Ÿæ¸¬å™¨æ­¸é›¶
        </div>

        <!-- åº§æ¨™è»¸é¡è‰²èªªæ˜ -->
        <div class="axis-legend">
            <div style="font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #fff;">ğŸ“ åº§æ¨™è»¸é¡è‰²</div>
            <div class="axis-item">
                <div class="axis-color-box axis-x"></div>
                <span>X è»¸ - ç´…è‰²</span>
            </div>
            <div class="axis-item">
                <div class="axis-color-box axis-y"></div>
                <span>Y è»¸ - ç¶ è‰²</span>
            </div>
            <div class="axis-item">
                <div class="axis-color-box axis-z"></div>
                <span>Z è»¸ - è—è‰²</span>
            </div>
        </div>

        <!-- é¸æ“‡é¼“æ£’ -->
        <div style="margin: 15px 0;">
            <label style="color: #aaa; display: block; margin-bottom: 5px;">é¸æ“‡é¼“æ£’:</label>
            <select id="offset-stick-selector" style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; color: white;">
                <option value="left">ğŸ‘ˆ å·¦æ‰‹ (Left)</option>
                <option value="right">ğŸ‘‰ å³æ‰‹ (Right)</option>
            </select>
        </div>

        <!-- åŠ é€Ÿåº¦ Offset è¼¸å…¥ -->
        <h3>åŠ é€Ÿåº¦ Offset (g)</h3>
        <div class="offset-input-row">
            <label>Accel X:</label>
            <input type="number" id="offset-accel-x" step="0.01" value="0" placeholder="0.00">
        </div>
        <div class="offset-input-row">
            <label>Accel Y:</label>
            <input type="number" id="offset-accel-y" step="0.01" value="0" placeholder="0.00">
        </div>
        <div class="offset-input-row">
            <label>Accel Z:</label>
            <input type="number" id="offset-accel-z" step="0.01" value="0" placeholder="0.00">
        </div>

        <!-- é™€èºå„€ Offset è¼¸å…¥ -->
        <h3>é™€èºå„€ Offset (Â°/s)</h3>
        <div class="offset-input-row">
            <label>Gyro X:</label>
            <input type="number" id="offset-gyro-x" step="0.1" value="0" placeholder="0.0">
        </div>
        <div class="offset-input-row">
            <label>Gyro Y:</label>
            <input type="number" id="offset-gyro-y" step="0.1" value="0" placeholder="0.0">
        </div>
        <div class="offset-input-row">
            <label>Gyro Z:</label>
            <input type="number" id="offset-gyro-z" step="0.1" value="0" placeholder="0.0">
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <button class="offset-btn" id="auto-zero-btn">ğŸ¯ è‡ªå‹•æ­¸é›¶ (ä½¿ç”¨ç•¶å‰å€¼)</button>
        <button class="offset-btn offset-btn-reset" id="reset-offset-btn">â†º é‡ç½®æ‰€æœ‰ Offset</button>

        <div style="margin-top: 10px; padding: 10px; background: rgba(79, 195, 247, 0.1); border-radius: 6px; font-size: 11px; color: #aaa;">
            ğŸ’¡ æç¤ºï¼šé»æ“Šã€Œè‡ªå‹•æ­¸é›¶ã€æœƒå°‡ç•¶å‰æ„Ÿæ¸¬å™¨è®€æ•¸è¨­ç‚º offsetï¼Œä½¿æ‰€æœ‰æ•¸æ“šè®Šç‚º 0
        </div>
    </div>

    <!-- åº•éƒ¨ç‹€æ…‹åˆ— -->
    <div id="status-bar">ğŸŸ¢ ç³»çµ±é‹è¡Œä¸­</div>

    <!-- ==================== JavaScript ç¨‹å¼å€ ==================== -->
    <script>
        // ============================================================
        // ã€å€å¡Š 1ã€‘å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®šåƒæ•¸
        // ============================================================

        // === Three.js å ´æ™¯ç‰©ä»¶ ===
        let scene, camera, renderer, controls;
        let leftDrumstick, rightDrumstick;
        let leftStickTip, rightStickTip;
        let hitParticles = [];

        // === æ„Ÿæ¸¬å™¨æ•¸æ“š Offset è¨­å®šï¼ˆç”¨æ–¼æ­¸é›¶æ ¡æº–ï¼‰===
        let sensorOffsets = {
            left: {
                accel: { x: 0, y: 0, z: 0 },
                gyro: { x: 0, y: 0, z: 0 }
            },
            right: {
                accel: { x: 0, y: 0, z: 0 },
                gyro: { x: 0, y: 0, z: 0 }
            }
        };

        // === ç•¶å‰é¸æ“‡çš„é¼“æ£’ï¼ˆç”¨æ–¼ offset æ§åˆ¶ï¼‰===
        let selectedOffsetStick = 'left';

        // === åŸå§‹æ„Ÿæ¸¬å™¨æ•¸æ“šï¼ˆç”¨æ–¼è‡ªå‹•æ­¸é›¶ï¼‰===
        let rawSensorData = {
            left: { accel: { x: 0, y: 0, z: 0 }, gyro: { x: 0, y: 0, z: 0 } },
            right: { accel: { x: 0, y: 0, z: 0 }, gyro: { x: 0, y: 0, z: 0 } }
        };

        // === æ‰“æ“Šç‹€æ…‹è¿½è¹¤ ===
        let prevLeftHitting = false;
        let prevRightHitting = false;

        const container = document.getElementById('scene-container');


        // ============================================================
        // ã€å€å¡Š 2ã€‘3D å ´æ™¯è¨­å®šåƒæ•¸å€
        // ============================================================

        const SCENE_CONFIG = {
            // ç›¸æ©Ÿè¨­å®š
            camera: {
                fov: 75,
                near: 0.1,
                far: 1000,
                position: { x: 3, y: 3, z: 4 }
            },

            // åº§æ¨™è»¸è¨­å®š
            axes: {
                size: 5,  // åº§æ¨™è»¸é•·åº¦
                markerSize: 0.1,  // è»¸ç«¯æ¨™è¨˜çƒé«”å¤§å°
                // Y-Z è»¸å°èª¿ï¼šYé¡¯ç¤ºåœ¨Zä½ç½®ï¼ŒZé¡¯ç¤ºåœ¨Yä½ç½®
                xMarkerPos: { x: 5, y: 0, z: 0 },
                yMarkerPos: { x: 0, y: 5, z: 0 },  
                zMarkerPos: { x: 0, y: 0, z: 5 }   
            },

            // ç‡ˆå…‰è¨­å®š
            lighting: {
                ambient: { color: 0x404040, intensity: 0.5 },
                spot1: { color: 0xFFFFFF, intensity: 3.5, distance: 10, position: { x: -3, y: 6, z: 2 } },
                spot2: { color: 0xFFFFFF, intensity: 3.5, distance: 10, position: { x: 3, y: 6, z: 2 } }
            },

            // åœ°æ¿è¨­å®š
            floor: {
                size: 15,
                color: 0x1A1A1A
            },

            // æ§åˆ¶å™¨è¨­å®š
            controls: {
                target: { x: 0, y: 1, z: 0 },
                minDistance: 2,
                maxDistance: 10,
                maxPolarAngle: Math.PI / 2.1
            }
        };


        // ============================================================
        // ã€å€å¡Š 3ã€‘é¼“æ£’èˆ‡çˆµå£«é¼“è¨­å®šåƒæ•¸å€
        // ============================================================

        const DRUMSTICK_CONFIG = {
            // é¼“æ£’å°ºå¯¸
            length: 1.2,
            radius: 0.02,
            tipRadius: 0.035,
            gripRadius: 0.024,
            gripLength: 0.15,

            // é¼“æ£’é¡è‰²
            colors: {
                left: 0xFBBF24,   // é»ƒè‰²
                right: 0x60A5FA,  // è—è‰²
                wood: 0xD2691E    // æœ¨é ­è‰²
            },

            // é¼“æ£’åˆå§‹ä½ç½®
            positions: {
                left: { x: -1.5, y: 1.5, z: 10 },
                right: { x: 1.5, y: 1.5, z: 0.5 }
            }
        };

        const DRUM_SET_CONFIG = {
            // çˆµå£«é¼“çµ„é¡è‰²
            drumColor: 0x8B0000,
            snareColor: 0xFFFFFF,
            cymbalColor: 0xAAAA00,
            standColor: 0x333333,

            // é¼“çš„ä½ç½®èˆ‡å°ºå¯¸
            bassDrum: { radius: 0.8, height: 0.7, position: { x: 0, y: 0, z: 0 } },
            snareDrum: { radius: 0.35, height: 0.2, position: { x: -1.0, y: 0.5, z: 0.5 } },
            tomDrum: { radius: 0.3, height: 0.3, position: { x: 0.6, y: 0.9, z: -0.6 } },

            // éˆ¸çš„ä½ç½®èˆ‡å°ºå¯¸
            hiHat: { radius: 0.4, position: { x: -1.5, y: 1.2, z: -0.2 } },
            rideCymbal: { radius: 0.6, position: { x: 1.8, y: 1.2, z: 0.5 } },
            crashCymbal: { radius: 0.5, position: { x: 0.5, y: 1.7, z: -1.5 } }
        };


        // ============================================================
        // ã€å€å¡Š 4ã€‘æ‰“æ“Šæ•ˆæœè¨­å®šåƒæ•¸å€
        // ============================================================

        const HIT_EFFECT_CONFIG = {
            particleCount: 20,      // ç²’å­æ•¸é‡
            particleSize: 0.08,     // ç²’å­å¤§å°
            lifetime: 1.0,          // ç²’å­å£½å‘½ï¼ˆç§’ï¼‰
            gravity: 0.01,          // é‡åŠ›æ•ˆæœ
            velocityRange: 0.3      // é€Ÿåº¦éš¨æ©Ÿç¯„åœ
        };


        // ============================================================
        // ã€å€å¡Š 5ã€‘æ•¸æ“šæ›´æ–°è¨­å®šåƒæ•¸å€
        // ============================================================

        const DATA_CONFIG = {
            updateInterval: 50,     // æ•¸æ“šæ›´æ–°é–“éš”ï¼ˆæ¯«ç§’ï¼‰
            hitThreshold: 2.0,      // æ‰“æ“Šé–¾å€¼ï¼ˆåŠ é€Ÿåº¦ï¼‰
            heightMultiplier: 0.1   // é«˜åº¦è®ŠåŒ–å€æ•¸
        };


        // ============================================================
        // ã€å€å¡Š 6ã€‘Three.js 3D ç‰©ä»¶å‰µå»ºå‡½æ•¸
        // ============================================================

        // --- å‰µå»ºé¼“æ£’ ---
        function createDrumstick(color) {
            const group = new THREE.Group();

            // é¼“æ£’ä¸»é«”ï¼ˆåœ“æŸ±é«”ï¼‰
            const stickGeometry = new THREE.CylinderGeometry(
                DRUMSTICK_CONFIG.radius,
                DRUMSTICK_CONFIG.radius * 0.7,
                DRUMSTICK_CONFIG.length,
                8
            );
            const stickMaterial = new THREE.MeshPhongMaterial({
                color: DRUMSTICK_CONFIG.colors.wood,
                shininess: 20
            });
            const stick = new THREE.Mesh(stickGeometry, stickMaterial);
            stick.rotation.z = Math.PI / 2; // æ°´å¹³æ”¾ç½®
            group.add(stick);

            // é¼“æ£’å°–ç«¯ï¼ˆçƒé«”ï¼‰
            const tipGeometry = new THREE.SphereGeometry(DRUMSTICK_CONFIG.tipRadius, 16, 16);
            const tipMaterial = new THREE.MeshPhongMaterial({
                color: color,
                emissive: color,
                emissiveIntensity: 0.3
            });
            const tip = new THREE.Mesh(tipGeometry, tipMaterial);
            tip.position.x = DRUMSTICK_CONFIG.length / 2;
            group.add(tip);

            // é¼“æ£’æ¡æŸ„æ¨™è¨˜ï¼ˆå½©è‰²ç’°ï¼‰
            const gripGeometry = new THREE.CylinderGeometry(
                DRUMSTICK_CONFIG.gripRadius,
                DRUMSTICK_CONFIG.gripRadius,
                DRUMSTICK_CONFIG.gripLength,
                8
            );
            const gripMaterial = new THREE.MeshPhongMaterial({ color: color });
            const grip = new THREE.Mesh(gripGeometry, gripMaterial);
            grip.rotation.z = Math.PI / 2;
            grip.position.x = -DRUMSTICK_CONFIG.length / 3;
            group.add(grip);

            group.castShadow = true;

            return { group, tip };
        }

        // --- å‰µå»ºæ‰“æ“Šç²’å­æ•ˆæœ ---
        function createHitEffect(position, color) {
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const velocities = [];

            for (let i = 0; i < HIT_EFFECT_CONFIG.particleCount; i++) {
                positions.push(position.x, position.y, position.z);

                // éš¨æ©Ÿé€Ÿåº¦
                velocities.push(
                    (Math.random() - 0.5) * HIT_EFFECT_CONFIG.velocityRange,
                    Math.random() * HIT_EFFECT_CONFIG.velocityRange,
                    (Math.random() - 0.5) * HIT_EFFECT_CONFIG.velocityRange
                );
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({
                color: color,
                size: HIT_EFFECT_CONFIG.particleSize,
                transparent: true,
                opacity: 1.0,
                blending: THREE.AdditiveBlending
            });

            const particles = new THREE.Points(geometry, material);
            scene.add(particles);

            hitParticles.push({
                particles: particles,
                velocities: velocities,
                lifetime: HIT_EFFECT_CONFIG.lifetime
            });
        }

        // --- æ›´æ–°æ‰“æ“Šç²’å­ ---
        function updateHitEffects() {
            for (let i = hitParticles.length - 1; i >= 0; i--) {
                const effect = hitParticles[i];
                effect.lifetime -= 0.016; // ç´„ 60 FPS

                if (effect.lifetime <= 0) {
                    scene.remove(effect.particles);
                    hitParticles.splice(i, 1);
                    continue;
                }

                // æ›´æ–°ç²’å­ä½ç½®
                const positions = effect.particles.geometry.attributes.position.array;
                for (let j = 0; j < positions.length; j += 3) {
                    positions[j] += effect.velocities[j];
                    positions[j + 1] += effect.velocities[j + 1];
                    positions[j + 2] += effect.velocities[j + 2];

                    // é‡åŠ›
                    effect.velocities[j + 1] -= HIT_EFFECT_CONFIG.gravity;
                }
                effect.particles.geometry.attributes.position.needsUpdate = true;

                // æ·¡å‡º
                effect.particles.material.opacity = effect.lifetime;
            }
        }

        // --- å‰µå»ºé¼“ ---
        function createDrum(radius, height, color, position, rotation) {
            const geometry = new THREE.CylinderGeometry(radius, radius, height, 32);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 80,
                specular: 0x555555
            });
            const drum = new THREE.Mesh(geometry, material);
            drum.position.set(position.x, position.y + height / 2, position.z);
            if (rotation) {
                drum.rotation.set(rotation.x, rotation.y, rotation.z);
            }
            drum.castShadow = true;
            drum.receiveShadow = true;
            scene.add(drum);
            return drum;
        }

        // --- å‰µå»ºéˆ¸ ---
        function createCymbal(radius, thickness, position, rotation) {
            const geometry = new THREE.CylinderGeometry(radius, radius * 0.9, thickness, 64);
            const material = new THREE.MeshStandardMaterial({
                color: DRUM_SET_CONFIG.cymbalColor,
                metalness: 0.9,
                roughness: 0.2,
                side: THREE.DoubleSide
            });
            const cymbal = new THREE.Mesh(geometry, material);
            cymbal.position.set(position.x, position.y, position.z);
            if (rotation) {
                cymbal.rotation.set(rotation.x, rotation.y, rotation.z);
            }
            cymbal.castShadow = true;
            cymbal.receiveShadow = true;
            scene.add(cymbal);
            return cymbal;
        }

        // --- å‰µå»ºæ”¯æ¶ ---
        function createStand(x, y, z, height) {
            const geometry = new THREE.CylinderGeometry(0.05, 0.05, height, 8);
            const material = new THREE.MeshLambertMaterial({ color: DRUM_SET_CONFIG.standColor });
            const stand = new THREE.Mesh(geometry, material);
            stand.position.set(x, y + height / 2, z);
            stand.castShadow = true;
            stand.receiveShadow = true;
            scene.add(stand);
            return stand;
        }


        // ============================================================
        // ã€å€å¡Š 7ã€‘Three.js å ´æ™¯åˆå§‹åŒ–å‡½æ•¸
        // ============================================================

        function init() {
            // å ´æ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            // ç›¸æ©Ÿ
            camera = new THREE.PerspectiveCamera(
                SCENE_CONFIG.camera.fov,
                window.innerWidth / window.innerHeight,
                SCENE_CONFIG.camera.near,
                SCENE_CONFIG.camera.far
            );
            camera.position.set(
                SCENE_CONFIG.camera.position.x,
                SCENE_CONFIG.camera.position.y,
                SCENE_CONFIG.camera.position.z
            );

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // ç‡ˆå…‰
            const ambientLight = new THREE.AmbientLight(
                SCENE_CONFIG.lighting.ambient.color,
                SCENE_CONFIG.lighting.ambient.intensity
            );
            scene.add(ambientLight);

            const spotLight1 = new THREE.SpotLight(
                SCENE_CONFIG.lighting.spot1.color,
                SCENE_CONFIG.lighting.spot1.intensity,
                SCENE_CONFIG.lighting.spot1.distance,
                Math.PI / 8, 0.5, 0.5
            );
            spotLight1.position.set(
                SCENE_CONFIG.lighting.spot1.position.x,
                SCENE_CONFIG.lighting.spot1.position.y,
                SCENE_CONFIG.lighting.spot1.position.z
            );
            spotLight1.target.position.set(0, 0.5, 0);
            spotLight1.castShadow = true;
            spotLight1.shadow.mapSize.width = 1024;
            spotLight1.shadow.mapSize.height = 1024;
            scene.add(spotLight1);
            scene.add(spotLight1.target);

            const spotLight2 = new THREE.SpotLight(
                SCENE_CONFIG.lighting.spot2.color,
                SCENE_CONFIG.lighting.spot2.intensity,
                SCENE_CONFIG.lighting.spot2.distance,
                Math.PI / 8, 0.5, 0.5
            );
            spotLight2.position.set(
                SCENE_CONFIG.lighting.spot2.position.x,
                SCENE_CONFIG.lighting.spot2.position.y,
                SCENE_CONFIG.lighting.spot2.position.z
            );
            spotLight2.target.position.set(0, 0.5, 0);
            spotLight2.castShadow = true;
            scene.add(spotLight2);
            scene.add(spotLight2.target);

            // åœ°æ¿
            const floorGeometry = new THREE.PlaneGeometry(
                SCENE_CONFIG.floor.size,
                SCENE_CONFIG.floor.size
            );
            const floorMaterial = new THREE.MeshLambertMaterial({
                color: SCENE_CONFIG.floor.color
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // æ·»åŠ åº§æ¨™è»¸
            const axesHelper = new THREE.AxesHelper(SCENE_CONFIG.axes.size);
            scene.add(axesHelper);

            // æ·»åŠ åº§æ¨™è»¸æ¨™ç±¤ï¼ˆä½¿ç”¨å°çƒé«”æ¨™è¨˜ï¼‰
            const markerGeometry = new THREE.SphereGeometry(SCENE_CONFIG.axes.markerSize, 16, 16);

            // X è»¸æ¨™è¨˜ï¼ˆç´…è‰²ï¼‰
            const xMarker = new THREE.Mesh(markerGeometry, new THREE.MeshBasicMaterial({ color: 0xff0000 }));
            xMarker.position.set(
                SCENE_CONFIG.axes.xMarkerPos.x,
                SCENE_CONFIG.axes.xMarkerPos.y,
                SCENE_CONFIG.axes.xMarkerPos.z
            );
            scene.add(xMarker);

            // Y è»¸æ¨™è¨˜ï¼ˆç¶ è‰²ï¼‰ - å°èª¿å¾Œé¡¯ç¤ºåœ¨ Z ä½ç½®
            const yMarker = new THREE.Mesh(markerGeometry, new THREE.MeshBasicMaterial({ color: 0x00ff00 }));
            yMarker.position.set(
                SCENE_CONFIG.axes.yMarkerPos.x,
                SCENE_CONFIG.axes.yMarkerPos.y,
                SCENE_CONFIG.axes.yMarkerPos.z
            );
            scene.add(yMarker);

            // Z è»¸æ¨™è¨˜ï¼ˆè—è‰²ï¼‰ - å°èª¿å¾Œé¡¯ç¤ºåœ¨ Y ä½ç½®
            const zMarker = new THREE.Mesh(markerGeometry, new THREE.MeshBasicMaterial({ color: 0x0000ff }));
            zMarker.position.set(
                SCENE_CONFIG.axes.zMarkerPos.x,
                SCENE_CONFIG.axes.zMarkerPos.y,
                SCENE_CONFIG.axes.zMarkerPos.z
            );
            scene.add(zMarker);

            // å‰µå»ºçˆµå£«é¼“çµ„
            const cfg = DRUM_SET_CONFIG;
            const BASE_Y = 0;

            // å¤§é¼“
            createDrum(
                cfg.bassDrum.radius,
                cfg.bassDrum.height,
                cfg.drumColor,
                cfg.bassDrum.position,
                { x: 0, y: 0, z: 0 }
            );

            // å°é¼“
            const snareStandHeight = 0.5;
            createStand(cfg.snareDrum.position.x, BASE_Y, cfg.snareDrum.position.z, snareStandHeight);
            createDrum(
                cfg.snareDrum.radius,
                cfg.snareDrum.height,
                cfg.snareColor,
                { x: cfg.snareDrum.position.x, y: BASE_Y + snareStandHeight, z: cfg.snareDrum.position.z },
                { x: -Math.PI / 16, y: 0, z: 0 }
            );

            // ä¸­é¼“
            const tomStandHeight = 0.9;
            createStand(cfg.tomDrum.position.x, BASE_Y, cfg.tomDrum.position.z, tomStandHeight);
            createDrum(
                cfg.tomDrum.radius,
                cfg.tomDrum.height,
                cfg.drumColor,
                { x: cfg.tomDrum.position.x, y: BASE_Y + tomStandHeight, z: cfg.tomDrum.position.z },
                { x: Math.PI / 16, y: 0, z: 0 }
            );

            // éˆ¸æ¶
            const standHeightTall = 1.2;

            // Hi-Hat
            createStand(cfg.hiHat.position.x, BASE_Y, cfg.hiHat.position.z, standHeightTall);
            createCymbal(cfg.hiHat.radius, 0.02,
                { x: cfg.hiHat.position.x, y: BASE_Y + standHeightTall, z: cfg.hiHat.position.z },
                { x: 0, y: 0, z: 0 }
            );
            createCymbal(cfg.hiHat.radius * 0.95, 0.01,
                { x: cfg.hiHat.position.x, y: BASE_Y + standHeightTall + 0.02, z: cfg.hiHat.position.z },
                { x: 0, y: 0, z: 0 }
            );

            // Ride Cymbal
            createStand(cfg.rideCymbal.position.x, BASE_Y, cfg.rideCymbal.position.z, standHeightTall);
            createCymbal(cfg.rideCymbal.radius, 0.02,
                { x: cfg.rideCymbal.position.x, y: BASE_Y + standHeightTall + 0.05, z: cfg.rideCymbal.position.z },
                { x: Math.PI / 8, y: 0, z: 0 }
            );

            // Crash Cymbal
            createStand(cfg.crashCymbal.position.x, BASE_Y, cfg.crashCymbal.position.z, standHeightTall + 0.5);
            createCymbal(cfg.crashCymbal.radius, 0.02,
                { x: cfg.crashCymbal.position.x, y: BASE_Y + standHeightTall + 0.5 + 0.05, z: cfg.crashCymbal.position.z },
                { x: Math.PI / 12, y: 0, z: 0 }
            );

            // å‰µå»ºå…©æ”¯é¼“æ£’
            const leftStick = createDrumstick(DRUMSTICK_CONFIG.colors.left);
            leftDrumstick = leftStick.group;
            leftStickTip = leftStick.tip;
            leftDrumstick.position.set(
                DRUMSTICK_CONFIG.positions.left.x,
                DRUMSTICK_CONFIG.positions.left.y,
                DRUMSTICK_CONFIG.positions.left.z
            );
            scene.add(leftDrumstick);

            const rightStick = createDrumstick(DRUMSTICK_CONFIG.colors.right);
            rightDrumstick = rightStick.group;
            rightStickTip = rightStick.tip;
            rightDrumstick.position.set(
                DRUMSTICK_CONFIG.positions.right.x,
                DRUMSTICK_CONFIG.positions.right.y,
                DRUMSTICK_CONFIG.positions.right.z
            );
            scene.add(rightDrumstick);

            // æ“æ§
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(
                SCENE_CONFIG.controls.target.x,
                SCENE_CONFIG.controls.target.y,
                SCENE_CONFIG.controls.target.z
            );
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = SCENE_CONFIG.controls.minDistance;
            controls.maxDistance = SCENE_CONFIG.controls.maxDistance;
            controls.maxPolarAngle = SCENE_CONFIG.controls.maxPolarAngle;

            // éŸ¿æ‡‰å¼è¨­è¨ˆ
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }


        // ============================================================
        // ã€å€å¡Š 8ã€‘é¼“æ£’ä½ç½®èˆ‡å§¿æ…‹æ›´æ–°å‡½æ•¸
        // ============================================================

        function updateDrumsticks(data) {
            if (!data || !leftDrumstick || !rightDrumstick) return;

            // æ›´æ–°å·¦æ‰‹é¼“æ£’
            if (data.left) {
                // æ ¹æ“šä¿¯ä»°è§’å’Œç¿»æ»¾è§’è¨ˆç®—é¼“æ£’å§¿æ…‹
                const leftPitch = data.left.angle.pitch * Math.PI / 180;
                const leftRoll = data.left.angle.roll * Math.PI / 180;

                // è¨­å®šé¼“æ£’æ—‹è½‰ï¼ˆæ ¹æ“šæ„Ÿæ¸¬å™¨æ•¸æ“šï¼‰
                leftDrumstick.rotation.x = leftPitch;
                leftDrumstick.rotation.z = leftRoll;

                // æ ¹æ“šæ‰“æ“Šä½ç½®èª¿æ•´ X åº§æ¨™
                if (data.left.hit_position === 'left') {
                    leftDrumstick.position.x = -1.5;
                } else if (data.left.hit_position === 'center') {
                    leftDrumstick.position.x = -0.5;
                } else if (data.left.hit_position === 'right') {
                    leftDrumstick.position.x = 0.5;
                }

                // æ ¹æ“šåŠ é€Ÿåº¦èª¿æ•´é«˜åº¦ï¼ˆæ¨¡æ“¬æ‰“æ“Šå‹•ä½œï¼‰
                const leftAccel = data.left.magnitude;
                if (leftAccel > DATA_CONFIG.hitThreshold) {
                    leftDrumstick.position.y = 1.0 + (leftAccel - DATA_CONFIG.hitThreshold) * DATA_CONFIG.heightMultiplier;
                } else {
                    leftDrumstick.position.y = 1.5;
                }

                // æ‰“æ“Šæ•ˆæœ
                if (data.left.is_hitting && !prevLeftHitting) {
                    const tipWorldPos = new THREE.Vector3();
                    leftStickTip.getWorldPosition(tipWorldPos);
                    createHitEffect(tipWorldPos, DRUMSTICK_CONFIG.colors.left);
                }
                prevLeftHitting = data.left.is_hitting;

                // æ›´æ–°è³‡è¨Šé¢æ¿
                updateInfoPanel('left', data.left);
            }

            // æ›´æ–°å³æ‰‹é¼“æ£’
            if (data.right) {
                const rightPitch = data.right.angle.pitch * Math.PI / 180;
                const rightRoll = data.right.angle.roll * Math.PI / 180;

                rightDrumstick.rotation.x = rightPitch;
                rightDrumstick.rotation.z = rightRoll;

                if (data.right.hit_position === 'left') {
                    rightDrumstick.position.x = -0.5;
                } else if (data.right.hit_position === 'center') {
                    rightDrumstick.position.x = 0.5;
                } else if (data.right.hit_position === 'right') {
                    rightDrumstick.position.x = 1.5;
                }

                const rightAccel = data.right.magnitude;
                if (rightAccel > DATA_CONFIG.hitThreshold) {
                    rightDrumstick.position.y = 1.0 + (rightAccel - DATA_CONFIG.hitThreshold) * DATA_CONFIG.heightMultiplier;
                } else {
                    rightDrumstick.position.y = 1.5;
                }

                if (data.right.is_hitting && !prevRightHitting) {
                    const tipWorldPos = new THREE.Vector3();
                    rightStickTip.getWorldPosition(tipWorldPos);
                    createHitEffect(tipWorldPos, DRUMSTICK_CONFIG.colors.right);
                }
                prevRightHitting = data.right.is_hitting;

                updateInfoPanel('right', data.right);
            }
        }


        // ============================================================
        // ã€å€å¡Š 9ã€‘è³‡è¨Šé¢æ¿æ›´æ–°å‡½æ•¸ï¼ˆå« Offset æ‡‰ç”¨ï¼‰
        // ============================================================

        function updateInfoPanel(side, stickData) {
            // å„²å­˜åŸå§‹æ•¸æ“š (ç”¨æ–¼è‡ªå‹•æ­¸é›¶)
            rawSensorData[side].accel = { ...stickData.accel };
            rawSensorData[side].gyro = { ...stickData.gyro };

            // æ‡‰ç”¨ offset
            const offset = sensorOffsets[side];
            const accelWithOffset = {
                x: stickData.accel.x - offset.accel.x,
                y: stickData.accel.y - offset.accel.y,
                z: stickData.accel.z - offset.accel.z
            };
            const gyroWithOffset = {
                x: stickData.gyro.x - offset.gyro.x,
                y: stickData.gyro.y - offset.gyro.y,
                z: stickData.gyro.z - offset.gyro.z
            };

            // æ›´æ–°è§’åº¦
            document.getElementById(`${side}-pitch`).textContent = stickData.angle.pitch.toFixed(1) + 'Â°';
            document.getElementById(`${side}-roll`).textContent = stickData.angle.roll.toFixed(1) + 'Â°';

            // æ›´æ–°ç¸½åŠ é€Ÿåº¦ (ä½¿ç”¨æ‡‰ç”¨ offset å¾Œçš„æ•¸æ“š)
            const magnitudeWithOffset = Math.sqrt(
                accelWithOffset.x ** 2 + accelWithOffset.y ** 2 + accelWithOffset.z ** 2
            );
            document.getElementById(`${side}-accel`).textContent = magnitudeWithOffset.toFixed(2) + ' g';

            // æ›´æ–°åŠ é€Ÿåº¦ XYZ (æ‡‰ç”¨ offset)
            document.getElementById(`${side}-accel-x`).textContent = accelWithOffset.x.toFixed(2) + ' g';
            document.getElementById(`${side}-accel-y`).textContent = accelWithOffset.y.toFixed(2) + ' g';
            document.getElementById(`${side}-accel-z`).textContent = accelWithOffset.z.toFixed(2) + ' g';

            // æ›´æ–°é™€èºå„€ XYZ (æ‡‰ç”¨ offset)
            document.getElementById(`${side}-gyro-x`).textContent = gyroWithOffset.x.toFixed(1) + 'Â°/s';
            document.getElementById(`${side}-gyro-y`).textContent = gyroWithOffset.y.toFixed(1) + 'Â°/s';
            document.getElementById(`${side}-gyro-z`).textContent = gyroWithOffset.z.toFixed(1) + 'Â°/s';

            // æ›´æ–°ä½ç½®æŒ‡ç¤ºå™¨
            const posEl = document.getElementById(`${side}-position`);
            if (stickData.hit_position) {
                const posText = {
                    'left': 'å·¦å´',
                    'center': 'ä¸­é–“',
                    'right': 'å³å´'
                };
                posEl.textContent = posText[stickData.hit_position];
                posEl.className = `position-indicator pos-${stickData.hit_position}`;
            } else {
                posEl.textContent = '---';
                posEl.className = 'position-indicator pos-none';
            }
        }


        // ============================================================
        // ã€å€å¡Š 10ã€‘å¾Œç«¯æ•¸æ“šç²å–èˆ‡å‹•ç•«å¾ªç’°
        // ============================================================

        // --- å¾å¾Œç«¯ç²å–æ•¸æ“š ---
        function fetchSensorData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    updateDrumsticks(data);
                })
                .catch(error => {
                    console.error('ç²å–æ•¸æ“šéŒ¯èª¤:', error);
                });
        }

        // --- å‹•ç•«å¾ªç’° ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updateHitEffects();
            renderer.render(scene, camera);
        }


        // ============================================================
        // ã€å€å¡Š 11ã€‘Offset æ§åˆ¶åŠŸèƒ½ï¼ˆæ„Ÿæ¸¬å™¨æ­¸é›¶ï¼‰
        // ============================================================

        // è¼‰å…¥ç•¶å‰é¸æ“‡é¼“æ£’çš„ offset åˆ°è¼¸å…¥æ¡†
        function loadOffsetInputs() {
            const stick = selectedOffsetStick;
            const offset = sensorOffsets[stick];

            document.getElementById('offset-accel-x').value = offset.accel.x.toFixed(2);
            document.getElementById('offset-accel-y').value = offset.accel.y.toFixed(2);
            document.getElementById('offset-accel-z').value = offset.accel.z.toFixed(2);
            document.getElementById('offset-gyro-x').value = offset.gyro.x.toFixed(1);
            document.getElementById('offset-gyro-y').value = offset.gyro.y.toFixed(1);
            document.getElementById('offset-gyro-z').value = offset.gyro.z.toFixed(1);
        }

        // å¾è¼¸å…¥æ¡†å„²å­˜ offset
        function saveOffsetFromInputs() {
            const stick = selectedOffsetStick;

            sensorOffsets[stick].accel.x = parseFloat(document.getElementById('offset-accel-x').value) || 0;
            sensorOffsets[stick].accel.y = parseFloat(document.getElementById('offset-accel-y').value) || 0;
            sensorOffsets[stick].accel.z = parseFloat(document.getElementById('offset-accel-z').value) || 0;
            sensorOffsets[stick].gyro.x = parseFloat(document.getElementById('offset-gyro-x').value) || 0;
            sensorOffsets[stick].gyro.y = parseFloat(document.getElementById('offset-gyro-y').value) || 0;
            sensorOffsets[stick].gyro.z = parseFloat(document.getElementById('offset-gyro-z').value) || 0;

            console.log(`å·²æ›´æ–° ${stick} æ‰‹é¼“æ£’çš„ offset:`, sensorOffsets[stick]);
        }


        // ============================================================
        // ã€å€å¡Š 12ã€‘UI äº‹ä»¶ç›£è½å™¨
        // ============================================================

        // é¼“æ£’é¸æ“‡å™¨åˆ‡æ›
        document.getElementById('offset-stick-selector').addEventListener('change', (e) => {
            selectedOffsetStick = e.target.value;
            loadOffsetInputs();
            console.log(`åˆ‡æ›åˆ° ${selectedOffsetStick} æ‰‹é¼“æ£’`);
        });

        // è¼¸å…¥æ¡†è®Šæ›´æ™‚è‡ªå‹•å„²å­˜
        ['offset-accel-x', 'offset-accel-y', 'offset-accel-z',
         'offset-gyro-x', 'offset-gyro-y', 'offset-gyro-z'].forEach(id => {
            document.getElementById(id).addEventListener('change', saveOffsetFromInputs);
        });

        // è‡ªå‹•æ­¸é›¶æŒ‰éˆ•
        document.getElementById('auto-zero-btn').addEventListener('click', () => {
            const stick = selectedOffsetStick;
            const raw = rawSensorData[stick];

            // å°‡ç•¶å‰è®€æ•¸è¨­ç‚º offset
            sensorOffsets[stick].accel = { ...raw.accel };
            sensorOffsets[stick].gyro = { ...raw.gyro };

            // æ›´æ–°è¼¸å…¥æ¡†
            loadOffsetInputs();

            console.log(`âœ“ å·²è‡ªå‹•æ­¸é›¶ ${stick} æ‰‹é¼“æ£’`);
            alert(`âœ“ å·²å°‡ ${stick === 'left' ? 'å·¦æ‰‹' : 'å³æ‰‹'} é¼“æ£’æ­¸é›¶`);
        });

        // é‡ç½® offset æŒ‰éˆ•
        document.getElementById('reset-offset-btn').addEventListener('click', () => {
            const stick = selectedOffsetStick;

            sensorOffsets[stick].accel = { x: 0, y: 0, z: 0 };
            sensorOffsets[stick].gyro = { x: 0, y: 0, z: 0 };

            loadOffsetInputs();

            console.log(`âœ“ å·²é‡ç½® ${stick} æ‰‹é¼“æ£’çš„ offset`);
            alert(`âœ“ å·²é‡ç½® ${stick === 'left' ? 'å·¦æ‰‹' : 'å³æ‰‹'} é¼“æ£’çš„ offset`);
        });


        // ============================================================
        // ã€å€å¡Š 13ã€‘æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        // ============================================================

        window.onload = function () {
            init();
            animate();

            // è¼‰å…¥åˆå§‹ offset è¨­å®š
            loadOffsetInputs();

            // æ¯ 50ms æ›´æ–°ä¸€æ¬¡æ•¸æ“š
            setInterval(fetchSensorData, DATA_CONFIG.updateInterval);
        };
    </script>
</body>
</html>
